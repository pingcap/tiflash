mysql> drop table if exists test.t;

mysql> create table test.t(id int);
mysql> alter table test.t set tiflash replica 1;

func> wait_table test t

# Disable flushing.
>> DBGInvoke __set_flush_threshold(1000000, 1000000)

# Insert a record and it should stay in kvstore.
mysql> insert into test.t values (1);

# Read once (not necessary).
mysql> set session tidb_isolation_read_engines='tiflash'; select * from test.t;
+------+
| id   |
+------+
|    1 |
+------+

# Drop table and force sync schema to make sure table in TiFlash is tombstoned.
mysql> drop table test.t;
>> DBGInvoke __refresh_schemas()

# Flush kvstore so that the record will be written into storage even if the storage is tombstoned.
>> DBGInvoke __try_flush()

# Recover table and force sync schema to make sure table in TiFlash is recovered.
mysql> recover table test.t;
>> DBGInvoke __refresh_schemas()

# Read again, the record should appear.
mysql> set session tidb_isolation_read_engines='tiflash'; select * from test.t;
+------+
| id   |
+------+
|    1 |
+------+

mysql> drop table if exists test.t;
