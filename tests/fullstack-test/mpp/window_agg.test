# Copyright 2025 PingCAP, Ltd.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http:#www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

mysql> drop table if exists test.t1;
mysql> create table test.t1 (p int, o int, v int not null);
mysql> insert into test.t1 values (0, 0, -1), (1, 0, -1), (1, 1, 0), (1, 3, 4), (1, 6, 6), (1, 7, -5), (1, 8, 3), (1, 18, 1), (1, 30, 30), (2, 0, 2), (2, 1, 0), (2, 4, -4), (2, 7, -2), (2, 8, 1), (2, 15, 2), (2, 30, -11), (3, 0, 7), (3, 4, -3), (3, 6, 9), (3, 10, -9), (3, 20, -3), (3, 40, 2), (3, 41, 1), (4, 0, 4), (5, 0, -5), (6, 0, 2), (6, 10, 5), (6, 30, 0), (7, 0, 3), (7, 1, 3), (7, 2, 2), (7, 3, -4), (7, 4, 9);
mysql> alter table test.t1 set tiflash replica 1;

mysql> drop table if exists test.t2;
mysql> create table test.t2 (p int, o int, v decimal(10, 2) not null);
mysql> insert into test.t2 values (0, 0, -1.12), (1, 0, -1.54), (1, 1, 0), (1, 3, 4.75), (1, 6, 6.02), (1, 7, -5.13), (1, 8, 3.94), (1, 18, 1.25), (1, 30, 30.67), (2, 0, 2.42), (2, 1, 0.45), (2, 4, -4.37), (2, 7, -2.37), (2, 8, 1.43), (2, 15, 2.16), (2, 30, -11.32), (3, 0, 7), (3, 4, -3.45), (3, 6, 9.23), (3, 10, -9.64), (3, 20, -3.72), (3, 40, 2.52), (3, 41, 1.36), (4, 0, 4.47), (5, 0, -5.82), (6, 0, 2.64), (6, 10, 5.72), (6, 30, 0.53), (7, 0, 3.64), (7, 1, 3.75), (7, 2, 2.33), (7, 3, -4.44), (7, 4, 9.62);
mysql> alter table test.t2 set tiflash replica 1;

mysql> drop table if exists test.t3;
mysql> create table test.t3 (p int, o int, v varchar(100) not null);
mysql> insert into test.t3 values (0, 0, ''), (1, 0, 'grwe4'), (1, 1, 'g43d'), (1, 3, 'hg5g4wgdsrv34g24gfthdgf4gberbvf34brebrgfrew'), (1, 6, 'g4sv'), (1, 7, 'g4sfe'), (1, 8, 'htxfdsg'), (1, 18, ''), (1, 30, 'fw4efv43g5f32ghrtnbt4vt435g9v4v45gFYHWEUHVUEtfg4g4'), (2, 0, 'gh5ervfdgerbvresgkope4w59ujg430o9ggv4ij6h5eb5by5rv4wfvr'), (2, 1, 'vnuiwvch23978vgbuysdihvbyifj490whjv4iuow34gvr'), (2, 4, 'gre'), (2, 7, 'hg5df'), (2, 8, 'gdve'), (2, 15, ''), (2, 30, 'gh345werfrf23ewg435g45Og45egrgbwerb4wgvb354vrg45erwgvw34fc4'), (3, 0, 'g4g4opuim'), (3, 4, 'phiiji'), (3, 6, 'h45htrhPh5htrV'), (3, 10, 'j7jhgvuev'), (3, 20, 'pmgo99f3'), (3, 40, ''), (3, 41, 'TGh54h54htever'), (4, 0, 'Gj6j6jf3gfw4'), (5, 0, 'g4effewsgfr'), (6, 0, 'h45yh5f33'), (6, 10, 'fg4wfwj6j'), (6, 30, 'gf34wf'), (7, 0, 'GFj6j6j6j6j6j32fwj6j6j6jyFf34'), (7, 1, 'G4wegfy54h5h5'), (7, 2, 'G4gwh6jh6j6j'), (7, 3, 'Gh54h45hg6rh3f3'), (7, 4, 'f43wg43wFG34y564g5');
mysql> alter table test.t3 set tiflash replica 1;

mysql> drop table if exists test.t4;
mysql> create table test.t4 (p int, o int, v int);
mysql> insert into test.t4 values (0, 0, -1), (1, 0, -1), (1, 1, null), (1, 3, 4), (1, 6, null), (1, 7, null), (1, 8, 3), (1, 18, null), (1, 30, null), (2, 0, 2), (2, 1, null), (2, 4, null), (2, 7, -2), (2, 8, 1), (2, 15, null), (2, 30, null), (3, 0, null), (3, 4, -3), (3, 6, 9), (3, 10, -9), (3, 20, null), (3, 40, 2), (3, 41, 1), (4, 0, 4), (5, 0, null), (6, 0, null), (6, 10, null), (6, 30, null), (7, 0, null), (7, 1, 3), (7, 2, null), (7, 3, -4), (7, 4, null);
mysql> alter table test.t4 set tiflash replica 1;

func> wait_table test t1
func> wait_table test t2
func> wait_table test t3
func> wait_table test t4

# bug mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", avg(v) over w as "avg", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 3 following and 1 following);
# TODO add tests for duplicate value in order column
# TODO add tests for t3

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", avg(v) over w as "avg", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 0 preceding and 0 following);
+------+------+-----+------+-------+----------+------+------+
| p    | o    | v   | sum  | count | avg      | min  | max  |
+------+------+-----+------+-------+----------+------+------+
|    0 |    0 |  -1 |   -1 |     1 |  -1.0000 |   -1 |   -1 |
|    1 |    0 |  -1 |   -1 |     1 |  -1.0000 |   -1 |   -1 |
|    1 |    1 |   0 |    0 |     1 |   0.0000 |    0 |    0 |
|    1 |    3 |   4 |    4 |     1 |   4.0000 |    4 |    4 |
|    1 |    6 |   6 |    6 |     1 |   6.0000 |    6 |    6 |
|    1 |    7 |  -5 |   -5 |     1 |  -5.0000 |   -5 |   -5 |
|    1 |    8 |   3 |    3 |     1 |   3.0000 |    3 |    3 |
|    1 |   18 |   1 |    1 |     1 |   1.0000 |    1 |    1 |
|    1 |   30 |  30 |   30 |     1 |  30.0000 |   30 |   30 |
|    2 |    0 |   2 |    2 |     1 |   2.0000 |    2 |    2 |
|    2 |    1 |   0 |    0 |     1 |   0.0000 |    0 |    0 |
|    2 |    4 |  -4 |   -4 |     1 |  -4.0000 |   -4 |   -4 |
|    2 |    7 |  -2 |   -2 |     1 |  -2.0000 |   -2 |   -2 |
|    2 |    8 |   1 |    1 |     1 |   1.0000 |    1 |    1 |
|    2 |   15 |   2 |    2 |     1 |   2.0000 |    2 |    2 |
|    2 |   30 | -11 |  -11 |     1 | -11.0000 |  -11 |  -11 |
|    3 |    0 |   7 |    7 |     1 |   7.0000 |    7 |    7 |
|    3 |    4 |  -3 |   -3 |     1 |  -3.0000 |   -3 |   -3 |
|    3 |    6 |   9 |    9 |     1 |   9.0000 |    9 |    9 |
|    3 |   10 |  -9 |   -9 |     1 |  -9.0000 |   -9 |   -9 |
|    3 |   20 |  -3 |   -3 |     1 |  -3.0000 |   -3 |   -3 |
|    3 |   40 |   2 |    2 |     1 |   2.0000 |    2 |    2 |
|    3 |   41 |   1 |    1 |     1 |   1.0000 |    1 |    1 |
|    4 |    0 |   4 |    4 |     1 |   4.0000 |    4 |    4 |
|    5 |    0 |  -5 |   -5 |     1 |  -5.0000 |   -5 |   -5 |
|    6 |    0 |   2 |    2 |     1 |   2.0000 |    2 |    2 |
|    6 |   10 |   5 |    5 |     1 |   5.0000 |    5 |    5 |
|    6 |   30 |   0 |    0 |     1 |   0.0000 |    0 |    0 |
|    7 |    0 |   3 |    3 |     1 |   3.0000 |    3 |    3 |
|    7 |    1 |   3 |    3 |     1 |   3.0000 |    3 |    3 |
|    7 |    2 |   2 |    2 |     1 |   2.0000 |    2 |    2 |
|    7 |    3 |  -4 |   -4 |     1 |  -4.0000 |   -4 |   -4 |
|    7 |    4 |   9 |    9 |     1 |   9.0000 |    9 |    9 |
+------+------+-----+------+-------+----------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", avg(v) over w as "avg", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 1 preceding and 0 following);
+------+------+-----+------+-------+---------+------+------+
| p    | o    | v   | sum  | count | avg     | min  | max  |
+------+------+-----+------+-------+---------+------+------+
|    4 |    0 |   4 |    4 |     1 |  4.0000 |    4 |    4 |
|    2 |    0 |   2 |    2 |     1 |  2.0000 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |  1.0000 |    0 |    2 |
|    2 |    4 |  -4 |   -4 |     2 | -2.0000 |   -4 |    0 |
|    2 |    7 |  -2 |   -6 |     2 | -3.0000 |   -4 |   -2 |
|    2 |    8 |   1 |   -1 |     2 | -0.5000 |   -2 |    1 |
|    2 |   15 |   2 |    3 |     2 |  1.5000 |    1 |    2 |
|    2 |   30 | -11 |   -9 |     2 | -4.5000 |  -11 |    2 |
|    5 |    0 |  -5 |   -5 |     1 | -5.0000 |   -5 |   -5 |
|    0 |    0 |  -1 |   -1 |     1 | -1.0000 |   -1 |   -1 |
|    3 |    0 |   7 |    7 |     1 |  7.0000 |    7 |    7 |
|    3 |    4 |  -3 |    4 |     2 |  2.0000 |   -3 |    7 |
|    3 |    6 |   9 |    6 |     2 |  3.0000 |   -3 |    9 |
|    3 |   10 |  -9 |    0 |     2 |  0.0000 |   -9 |    9 |
|    3 |   20 |  -3 |  -12 |     2 | -6.0000 |   -9 |   -3 |
|    3 |   40 |   2 |   -1 |     2 | -0.5000 |   -3 |    2 |
|    3 |   41 |   1 |    3 |     2 |  1.5000 |    1 |    2 |
|    1 |    0 |  -1 |   -1 |     1 | -1.0000 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 | -0.5000 |   -1 |    0 |
|    1 |    3 |   4 |    4 |     2 |  2.0000 |    0 |    4 |
|    1 |    6 |   6 |   10 |     2 |  5.0000 |    4 |    6 |
|    1 |    7 |  -5 |    1 |     2 |  0.5000 |   -5 |    6 |
|    1 |    8 |   3 |   -2 |     2 | -1.0000 |   -5 |    3 |
|    1 |   18 |   1 |    4 |     2 |  2.0000 |    1 |    3 |
|    1 |   30 |  30 |   31 |     2 | 15.5000 |    1 |   30 |
|    7 |    0 |   3 |    3 |     1 |  3.0000 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |  3.0000 |    3 |    3 |
|    7 |    2 |   2 |    5 |     2 |  2.5000 |    2 |    3 |
|    7 |    3 |  -4 |   -2 |     2 | -1.0000 |   -4 |    2 |
|    7 |    4 |   9 |    5 |     2 |  2.5000 |   -4 |    9 |
|    6 |    0 |   2 |    2 |     1 |  2.0000 |    2 |    2 |
|    6 |   10 |   5 |    7 |     2 |  3.5000 |    2 |    5 |
|    6 |   30 |   0 |    5 |     2 |  2.5000 |    0 |    5 |
+------+------+-----+------+-------+---------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 2 preceding and 0 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -2 |     3 |   -4 |    2 |
|    2 |    7 |  -2 |   -6 |     3 |   -4 |    0 |
|    2 |    8 |   1 |   -5 |     3 |   -4 |    1 |
|    2 |   15 |   2 |    1 |     3 |   -2 |    2 |
|    2 |   30 | -11 |   -8 |     3 |  -11 |    2 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |    4 |     2 |   -3 |    7 |
|    3 |    6 |   9 |   13 |     3 |   -3 |    9 |
|    3 |   10 |  -9 |   -3 |     3 |   -9 |    9 |
|    3 |   20 |  -3 |   -3 |     3 |   -9 |    9 |
|    3 |   40 |   2 |  -10 |     3 |   -9 |    2 |
|    3 |   41 |   1 |    0 |     3 |   -3 |    2 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    7 |     2 |    2 |    5 |
|    6 |   30 |   0 |    7 |     3 |    0 |    5 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    3 |     3 |   -1 |    4 |
|    1 |    6 |   6 |   10 |     3 |    0 |    6 |
|    1 |    7 |  -5 |    5 |     3 |   -5 |    6 |
|    1 |    8 |   3 |    4 |     3 |   -5 |    6 |
|    1 |   18 |   1 |   -1 |     3 |   -5 |    3 |
|    1 |   30 |  30 |   34 |     3 |    1 |   30 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |    3 |    3 |
|    7 |    2 |   2 |    8 |     3 |    2 |    3 |
|    7 |    3 |  -4 |    1 |     3 |   -4 |    3 |
|    7 |    4 |   9 |    7 |     3 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 3 preceding and 0 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    3 |     3 |   -1 |    4 |
|    1 |    6 |   6 |    9 |     4 |   -1 |    6 |
|    1 |    7 |  -5 |    5 |     4 |   -5 |    6 |
|    1 |    8 |   3 |    8 |     4 |   -5 |    6 |
|    1 |   18 |   1 |    5 |     4 |   -5 |    6 |
|    1 |   30 |  30 |   29 |     4 |   -5 |   30 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -2 |     3 |   -4 |    2 |
|    2 |    7 |  -2 |   -4 |     4 |   -4 |    2 |
|    2 |    8 |   1 |   -5 |     4 |   -4 |    1 |
|    2 |   15 |   2 |   -3 |     4 |   -4 |    2 |
|    2 |   30 | -11 |  -10 |     4 |  -11 |    2 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |    4 |     2 |   -3 |    7 |
|    3 |    6 |   9 |   13 |     3 |   -3 |    9 |
|    3 |   10 |  -9 |    4 |     4 |   -9 |    9 |
|    3 |   20 |  -3 |   -6 |     4 |   -9 |    9 |
|    3 |   40 |   2 |   -1 |     4 |   -9 |    9 |
|    3 |   41 |   1 |   -9 |     4 |   -9 |    2 |
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    7 |     2 |    2 |    5 |
|    6 |   30 |   0 |    7 |     3 |    0 |    5 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |    3 |    3 |
|    7 |    2 |   2 |    8 |     3 |    2 |    3 |
|    7 |    3 |  -4 |    4 |     4 |   -4 |    3 |
|    7 |    4 |   9 |   10 |     4 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 3 preceding and 1 preceding);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 | NULL |     0 | NULL | NULL |
|    0 |    0 |  -1 | NULL |     0 | NULL | NULL |
|    5 |    0 |  -5 | NULL |     0 | NULL | NULL |
|    2 |    0 |   2 | NULL |     0 | NULL | NULL |
|    2 |    1 |   0 |    2 |     1 |    2 |    2 |
|    2 |    4 |  -4 |    2 |     2 |    0 |    2 |
|    2 |    7 |  -2 |   -2 |     3 |   -4 |    2 |
|    2 |    8 |   1 |   -6 |     3 |   -4 |    0 |
|    2 |   15 |   2 |   -5 |     3 |   -4 |    1 |
|    2 |   30 | -11 |    1 |     3 |   -2 |    2 |
|    1 |    0 |  -1 | NULL |     0 | NULL | NULL |
|    1 |    1 |   0 |   -1 |     1 |   -1 |   -1 |
|    1 |    3 |   4 |   -1 |     2 |   -1 |    0 |
|    1 |    6 |   6 |    3 |     3 |   -1 |    4 |
|    1 |    7 |  -5 |   10 |     3 |    0 |    6 |
|    1 |    8 |   3 |    5 |     3 |   -5 |    6 |
|    1 |   18 |   1 |    4 |     3 |   -5 |    6 |
|    1 |   30 |  30 |   -1 |     3 |   -5 |    3 |
|    3 |    0 |   7 | NULL |     0 | NULL | NULL |
|    3 |    4 |  -3 |    7 |     1 |    7 |    7 |
|    3 |    6 |   9 |    4 |     2 |   -3 |    7 |
|    3 |   10 |  -9 |   13 |     3 |   -3 |    9 |
|    3 |   20 |  -3 |   -3 |     3 |   -9 |    9 |
|    3 |   40 |   2 |   -3 |     3 |   -9 |    9 |
|    3 |   41 |   1 |  -10 |     3 |   -9 |    2 |
|    6 |    0 |   2 | NULL |     0 | NULL | NULL |
|    6 |   10 |   5 |    2 |     1 |    2 |    2 |
|    6 |   30 |   0 |    7 |     2 |    2 |    5 |
|    7 |    0 |   3 | NULL |     0 | NULL | NULL |
|    7 |    1 |   3 |    3 |     1 |    3 |    3 |
|    7 |    2 |   2 |    6 |     2 |    3 |    3 |
|    7 |    3 |  -4 |    8 |     3 |    2 |    3 |
|    7 |    4 |   9 |    1 |     3 |   -4 |    3 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 1 following and 3 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 | NULL |     0 | NULL | NULL |
|    2 |    0 |   2 |   -6 |     3 |   -4 |    0 |
|    2 |    1 |   0 |   -5 |     3 |   -4 |    1 |
|    2 |    4 |  -4 |    1 |     3 |   -2 |    2 |
|    2 |    7 |  -2 |   -8 |     3 |  -11 |    2 |
|    2 |    8 |   1 |   -9 |     2 |  -11 |    2 |
|    2 |   15 |   2 |  -11 |     1 |  -11 |  -11 |
|    2 |   30 | -11 | NULL |     0 | NULL | NULL |
|    0 |    0 |  -1 | NULL |     0 | NULL | NULL |
|    5 |    0 |  -5 | NULL |     0 | NULL | NULL |
|    3 |    0 |   7 |   -3 |     3 |   -9 |    9 |
|    3 |    4 |  -3 |   -3 |     3 |   -9 |    9 |
|    3 |    6 |   9 |  -10 |     3 |   -9 |    2 |
|    3 |   10 |  -9 |    0 |     3 |   -3 |    2 |
|    3 |   20 |  -3 |    3 |     2 |    1 |    2 |
|    3 |   40 |   2 |    1 |     1 |    1 |    1 |
|    3 |   41 |   1 | NULL |     0 | NULL | NULL |
|    1 |    0 |  -1 |   10 |     3 |    0 |    6 |
|    1 |    1 |   0 |    5 |     3 |   -5 |    6 |
|    1 |    3 |   4 |    4 |     3 |   -5 |    6 |
|    1 |    6 |   6 |   -1 |     3 |   -5 |    3 |
|    1 |    7 |  -5 |   34 |     3 |    1 |   30 |
|    1 |    8 |   3 |   31 |     2 |    1 |   30 |
|    1 |   18 |   1 |   30 |     1 |   30 |   30 |
|    1 |   30 |  30 | NULL |     0 | NULL | NULL |
|    6 |    0 |   2 |    5 |     2 |    0 |    5 |
|    6 |   10 |   5 |    0 |     1 |    0 |    0 |
|    6 |   30 |   0 | NULL |     0 | NULL | NULL |
|    7 |    0 |   3 |    1 |     3 |   -4 |    3 |
|    7 |    1 |   3 |    7 |     3 |   -4 |    9 |
|    7 |    2 |   2 |    5 |     2 |   -4 |    9 |
|    7 |    3 |  -4 |    9 |     1 |    9 |    9 |
|    7 |    4 |   9 | NULL |     0 | NULL | NULL |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t2 window w as (partition by p order by o rows between 0 preceding and 0 following);
+------+------+--------+--------+-------+--------+--------+
| p    | o    | v      | sum    | count | min    | max    |
+------+------+--------+--------+-------+--------+--------+
|    0 |    0 |  -1.12 |  -1.12 |     1 |  -1.12 |  -1.12 |
|    1 |    0 |  -1.54 |  -1.54 |     1 |  -1.54 |  -1.54 |
|    1 |    1 |   0.00 |   0.00 |     1 |   0.00 |   0.00 |
|    1 |    3 |   4.75 |   4.75 |     1 |   4.75 |   4.75 |
|    1 |    6 |   6.02 |   6.02 |     1 |   6.02 |   6.02 |
|    1 |    7 |  -5.13 |  -5.13 |     1 |  -5.13 |  -5.13 |
|    1 |    8 |   3.94 |   3.94 |     1 |   3.94 |   3.94 |
|    1 |   18 |   1.25 |   1.25 |     1 |   1.25 |   1.25 |
|    1 |   30 |  30.67 |  30.67 |     1 |  30.67 |  30.67 |
|    2 |    0 |   2.42 |   2.42 |     1 |   2.42 |   2.42 |
|    2 |    1 |   0.45 |   0.45 |     1 |   0.45 |   0.45 |
|    2 |    4 |  -4.37 |  -4.37 |     1 |  -4.37 |  -4.37 |
|    2 |    7 |  -2.37 |  -2.37 |     1 |  -2.37 |  -2.37 |
|    2 |    8 |   1.43 |   1.43 |     1 |   1.43 |   1.43 |
|    2 |   15 |   2.16 |   2.16 |     1 |   2.16 |   2.16 |
|    2 |   30 | -11.32 | -11.32 |     1 | -11.32 | -11.32 |
|    3 |    0 |   7.00 |   7.00 |     1 |   7.00 |   7.00 |
|    3 |    4 |  -3.45 |  -3.45 |     1 |  -3.45 |  -3.45 |
|    3 |    6 |   9.23 |   9.23 |     1 |   9.23 |   9.23 |
|    3 |   10 |  -9.64 |  -9.64 |     1 |  -9.64 |  -9.64 |
|    3 |   20 |  -3.72 |  -3.72 |     1 |  -3.72 |  -3.72 |
|    3 |   40 |   2.52 |   2.52 |     1 |   2.52 |   2.52 |
|    3 |   41 |   1.36 |   1.36 |     1 |   1.36 |   1.36 |
|    4 |    0 |   4.47 |   4.47 |     1 |   4.47 |   4.47 |
|    5 |    0 |  -5.82 |  -5.82 |     1 |  -5.82 |  -5.82 |
|    6 |    0 |   2.64 |   2.64 |     1 |   2.64 |   2.64 |
|    6 |   10 |   5.72 |   5.72 |     1 |   5.72 |   5.72 |
|    6 |   30 |   0.53 |   0.53 |     1 |   0.53 |   0.53 |
|    7 |    0 |   3.64 |   3.64 |     1 |   3.64 |   3.64 |
|    7 |    1 |   3.75 |   3.75 |     1 |   3.75 |   3.75 |
|    7 |    2 |   2.33 |   2.33 |     1 |   2.33 |   2.33 |
|    7 |    3 |  -4.44 |  -4.44 |     1 |  -4.44 |  -4.44 |
|    7 |    4 |   9.62 |   9.62 |     1 |   9.62 |   9.62 |
+------+------+--------+--------+-------+--------+--------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t2 window w as (partition by p order by o rows between 1 preceding and 0 following);
+------+------+--------+--------+-------+--------+-------+
| p    | o    | v      | sum    | count | min    | max   |
+------+------+--------+--------+-------+--------+-------+
|    0 |    0 |  -1.12 |  -1.12 |     1 |  -1.12 | -1.12 |
|    1 |    0 |  -1.54 |  -1.54 |     1 |  -1.54 | -1.54 |
|    1 |    1 |   0.00 |  -1.54 |     2 |  -1.54 |  0.00 |
|    1 |    3 |   4.75 |   4.75 |     2 |   0.00 |  4.75 |
|    1 |    6 |   6.02 |  10.77 |     2 |   4.75 |  6.02 |
|    1 |    7 |  -5.13 |   0.89 |     2 |  -5.13 |  6.02 |
|    1 |    8 |   3.94 |  -1.19 |     2 |  -5.13 |  3.94 |
|    1 |   18 |   1.25 |   5.19 |     2 |   1.25 |  3.94 |
|    1 |   30 |  30.67 |  31.92 |     2 |   1.25 | 30.67 |
|    2 |    0 |   2.42 |   2.42 |     1 |   2.42 |  2.42 |
|    2 |    1 |   0.45 |   2.87 |     2 |   0.45 |  2.42 |
|    2 |    4 |  -4.37 |  -3.92 |     2 |  -4.37 |  0.45 |
|    2 |    7 |  -2.37 |  -6.74 |     2 |  -4.37 | -2.37 |
|    2 |    8 |   1.43 |  -0.94 |     2 |  -2.37 |  1.43 |
|    2 |   15 |   2.16 |   3.59 |     2 |   1.43 |  2.16 |
|    2 |   30 | -11.32 |  -9.16 |     2 | -11.32 |  2.16 |
|    3 |    0 |   7.00 |   7.00 |     1 |   7.00 |  7.00 |
|    3 |    4 |  -3.45 |   3.55 |     2 |  -3.45 |  7.00 |
|    3 |    6 |   9.23 |   5.78 |     2 |  -3.45 |  9.23 |
|    3 |   10 |  -9.64 |  -0.41 |     2 |  -9.64 |  9.23 |
|    3 |   20 |  -3.72 | -13.36 |     2 |  -9.64 | -3.72 |
|    3 |   40 |   2.52 |  -1.20 |     2 |  -3.72 |  2.52 |
|    3 |   41 |   1.36 |   3.88 |     2 |   1.36 |  2.52 |
|    4 |    0 |   4.47 |   4.47 |     1 |   4.47 |  4.47 |
|    5 |    0 |  -5.82 |  -5.82 |     1 |  -5.82 | -5.82 |
|    6 |    0 |   2.64 |   2.64 |     1 |   2.64 |  2.64 |
|    6 |   10 |   5.72 |   8.36 |     2 |   2.64 |  5.72 |
|    6 |   30 |   0.53 |   6.25 |     2 |   0.53 |  5.72 |
|    7 |    0 |   3.64 |   3.64 |     1 |   3.64 |  3.64 |
|    7 |    1 |   3.75 |   7.39 |     2 |   3.64 |  3.75 |
|    7 |    2 |   2.33 |   6.08 |     2 |   2.33 |  3.75 |
|    7 |    3 |  -4.44 |  -2.11 |     2 |  -4.44 |  2.33 |
|    7 |    4 |   9.62 |   5.18 |     2 |  -4.44 |  9.62 |
+------+------+--------+--------+-------+--------+-------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t2 window w as (partition by p order by o rows between 3 preceding and 0 following);
+------+------+--------+--------+-------+--------+-------+
| p    | o    | v      | sum    | count | min    | max   |
+------+------+--------+--------+-------+--------+-------+
|    4 |    0 |   4.47 |   4.47 |     1 |   4.47 |  4.47 |
|    0 |    0 |  -1.12 |  -1.12 |     1 |  -1.12 | -1.12 |
|    5 |    0 |  -5.82 |  -5.82 |     1 |  -5.82 | -5.82 |
|    2 |    0 |   2.42 |   2.42 |     1 |   2.42 |  2.42 |
|    2 |    1 |   0.45 |   2.87 |     2 |   0.45 |  2.42 |
|    2 |    4 |  -4.37 |  -1.50 |     3 |  -4.37 |  2.42 |
|    2 |    7 |  -2.37 |  -3.87 |     4 |  -4.37 |  2.42 |
|    2 |    8 |   1.43 |  -4.86 |     4 |  -4.37 |  1.43 |
|    2 |   15 |   2.16 |  -3.15 |     4 |  -4.37 |  2.16 |
|    2 |   30 | -11.32 | -10.10 |     4 | -11.32 |  2.16 |
|    3 |    0 |   7.00 |   7.00 |     1 |   7.00 |  7.00 |
|    3 |    4 |  -3.45 |   3.55 |     2 |  -3.45 |  7.00 |
|    3 |    6 |   9.23 |  12.78 |     3 |  -3.45 |  9.23 |
|    3 |   10 |  -9.64 |   3.14 |     4 |  -9.64 |  9.23 |
|    3 |   20 |  -3.72 |  -7.58 |     4 |  -9.64 |  9.23 |
|    3 |   40 |   2.52 |  -1.61 |     4 |  -9.64 |  9.23 |
|    3 |   41 |   1.36 |  -9.48 |     4 |  -9.64 |  2.52 |
|    1 |    0 |  -1.54 |  -1.54 |     1 |  -1.54 | -1.54 |
|    1 |    1 |   0.00 |  -1.54 |     2 |  -1.54 |  0.00 |
|    1 |    3 |   4.75 |   3.21 |     3 |  -1.54 |  4.75 |
|    1 |    6 |   6.02 |   9.23 |     4 |  -1.54 |  6.02 |
|    1 |    7 |  -5.13 |   5.64 |     4 |  -5.13 |  6.02 |
|    1 |    8 |   3.94 |   9.58 |     4 |  -5.13 |  6.02 |
|    1 |   18 |   1.25 |   6.08 |     4 |  -5.13 |  6.02 |
|    1 |   30 |  30.67 |  30.73 |     4 |  -5.13 | 30.67 |
|    7 |    0 |   3.64 |   3.64 |     1 |   3.64 |  3.64 |
|    7 |    1 |   3.75 |   7.39 |     2 |   3.64 |  3.75 |
|    7 |    2 |   2.33 |   9.72 |     3 |   2.33 |  3.75 |
|    7 |    3 |  -4.44 |   5.28 |     4 |  -4.44 |  3.75 |
|    7 |    4 |   9.62 |  11.26 |     4 |  -4.44 |  9.62 |
|    6 |    0 |   2.64 |   2.64 |     1 |   2.64 |  2.64 |
|    6 |   10 |   5.72 |   8.36 |     2 |   2.64 |  5.72 |
|    6 |   30 |   0.53 |   8.89 |     3 |   0.53 |  5.72 |
+------+------+--------+--------+-------+--------+-------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t4 window w as (partition by p order by o rows between 3 preceding and 0 following);
+------+------+------+------+-------+------+------+
| p    | o    | v    | sum  | count | min  | max  |
+------+------+------+------+-------+------+------+
|    4 |    0 |    4 |    4 |     1 |    4 |    4 |
|    2 |    0 |    2 |    2 |     1 |    2 |    2 |
|    2 |    1 | NULL |    2 |     1 |    2 |    2 |
|    2 |    4 | NULL |    2 |     1 |    2 |    2 |
|    2 |    7 |   -2 |    0 |     2 |   -2 |    2 |
|    2 |    8 |    1 |   -1 |     2 |   -2 |    1 |
|    2 |   15 | NULL |   -1 |     2 |   -2 |    1 |
|    2 |   30 | NULL |   -1 |     2 |   -2 |    1 |
|    5 |    0 | NULL | NULL |     0 | NULL | NULL |
|    0 |    0 |   -1 |   -1 |     1 |   -1 |   -1 |
|    3 |    0 | NULL | NULL |     0 | NULL | NULL |
|    3 |    4 |   -3 |   -3 |     1 |   -3 |   -3 |
|    3 |    6 |    9 |    6 |     2 |   -3 |    9 |
|    3 |   10 |   -9 |   -3 |     3 |   -9 |    9 |
|    3 |   20 | NULL |   -3 |     3 |   -9 |    9 |
|    3 |   40 |    2 |    2 |     3 |   -9 |    9 |
|    3 |   41 |    1 |   -6 |     3 |   -9 |    2 |
|    1 |    0 |   -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 | NULL |   -1 |     1 |   -1 |   -1 |
|    1 |    3 |    4 |    3 |     2 |   -1 |    4 |
|    1 |    6 | NULL |    3 |     2 |   -1 |    4 |
|    1 |    7 | NULL |    4 |     1 |    4 |    4 |
|    1 |    8 |    3 |    7 |     2 |    3 |    4 |
|    1 |   18 | NULL |    3 |     1 |    3 |    3 |
|    1 |   30 | NULL |    3 |     1 |    3 |    3 |
|    7 |    0 | NULL | NULL |     0 | NULL | NULL |
|    7 |    1 |    3 |    3 |     1 |    3 |    3 |
|    7 |    2 | NULL |    3 |     1 |    3 |    3 |
|    7 |    3 |   -4 |   -1 |     2 |   -4 |    3 |
|    7 |    4 | NULL |   -1 |     2 |   -4 |    3 |
|    6 |    0 | NULL | NULL |     0 | NULL | NULL |
|    6 |   10 | NULL | NULL |     0 | NULL | NULL |
|    6 |   30 | NULL | NULL |     0 | NULL | NULL |
+------+------+------+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o range between 0 preceding and 0 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    0 |     1 |    0 |    0 |
|    2 |    4 |  -4 |   -4 |     1 |   -4 |   -4 |
|    2 |    7 |  -2 |   -2 |     1 |   -2 |   -2 |
|    2 |    8 |   1 |    1 |     1 |    1 |    1 |
|    2 |   15 |   2 |    2 |     1 |    2 |    2 |
|    2 |   30 | -11 |  -11 |     1 |  -11 |  -11 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    3 |     1 |    3 |    3 |
|    7 |    2 |   2 |    2 |     1 |    2 |    2 |
|    7 |    3 |  -4 |   -4 |     1 |   -4 |   -4 |
|    7 |    4 |   9 |    9 |     1 |    9 |    9 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    5 |     1 |    5 |    5 |
|    6 |   30 |   0 |    0 |     1 |    0 |    0 |
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |    6 |   9 |    9 |     1 |    9 |    9 |
|    3 |   10 |  -9 |   -9 |     1 |   -9 |   -9 |
|    3 |   20 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |   40 |   2 |    2 |     1 |    2 |    2 |
|    3 |   41 |   1 |    1 |     1 |    1 |    1 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |    0 |     1 |    0 |    0 |
|    1 |    3 |   4 |    4 |     1 |    4 |    4 |
|    1 |    6 |   6 |    6 |     1 |    6 |    6 |
|    1 |    7 |  -5 |   -5 |     1 |   -5 |   -5 |
|    1 |    8 |   3 |    3 |     1 |    3 |    3 |
|    1 |   18 |   1 |    1 |     1 |    1 |    1 |
|    1 |   30 |  30 |   30 |     1 |   30 |   30 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o range between 1 preceding and 0 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -4 |     1 |   -4 |   -4 |
|    2 |    7 |  -2 |   -2 |     1 |   -2 |   -2 |
|    2 |    8 |   1 |   -1 |     2 |   -2 |    1 |
|    2 |   15 |   2 |    2 |     1 |    2 |    2 |
|    2 |   30 | -11 |  -11 |     1 |  -11 |  -11 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |    6 |   9 |    9 |     1 |    9 |    9 |
|    3 |   10 |  -9 |   -9 |     1 |   -9 |   -9 |
|    3 |   20 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |   40 |   2 |    2 |     1 |    2 |    2 |
|    3 |   41 |   1 |    3 |     2 |    1 |    2 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    4 |     1 |    4 |    4 |
|    1 |    6 |   6 |    6 |     1 |    6 |    6 |
|    1 |    7 |  -5 |    1 |     2 |   -5 |    6 |
|    1 |    8 |   3 |   -2 |     2 |   -5 |    3 |
|    1 |   18 |   1 |    1 |     1 |    1 |    1 |
|    1 |   30 |  30 |   30 |     1 |   30 |   30 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    5 |     1 |    5 |    5 |
|    6 |   30 |   0 |    0 |     1 |    0 |    0 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |    3 |    3 |
|    7 |    2 |   2 |    5 |     2 |    2 |    3 |
|    7 |    3 |  -4 |   -2 |     2 |   -4 |    2 |
|    7 |    4 |   9 |    5 |     2 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o range between 3 preceding and 1 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    2 |    0 |   2 |    2 |     2 |    0 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -4 |     2 |   -4 |    0 |
|    2 |    7 |  -2 |   -5 |     3 |   -4 |    1 |
|    2 |    8 |   1 |   -1 |     2 |   -2 |    1 |
|    2 |   15 |   2 |    2 |     1 |    2 |    2 |
|    2 |   30 | -11 |  -11 |     1 |  -11 |  -11 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    0 |  -1 |   -1 |     2 |   -1 |    0 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    3 |     3 |   -1 |    4 |
|    1 |    6 |   6 |    5 |     3 |   -5 |    6 |
|    1 |    7 |  -5 |    4 |     3 |   -5 |    6 |
|    1 |    8 |   3 |    4 |     3 |   -5 |    6 |
|    1 |   18 |   1 |    1 |     1 |    1 |    1 |
|    1 |   30 |  30 |   30 |     1 |   30 |   30 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |    6 |   9 |    6 |     2 |   -3 |    9 |
|    3 |   10 |  -9 |   -9 |     1 |   -9 |   -9 |
|    3 |   20 |  -3 |   -3 |     1 |   -3 |   -3 |
|    3 |   40 |   2 |    3 |     2 |    1 |    2 |
|    3 |   41 |   1 |    3 |     2 |    1 |    2 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    5 |     1 |    5 |    5 |
|    6 |   30 |   0 |    0 |     1 |    0 |    0 |
|    7 |    0 |   3 |    6 |     2 |    3 |    3 |
|    7 |    1 |   3 |    8 |     3 |    2 |    3 |
|    7 |    2 |   2 |    4 |     4 |   -4 |    3 |
|    7 |    3 |  -4 |   13 |     5 |   -4 |    9 |
|    7 |    4 |   9 |   10 |     4 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, min(v) over w as "min", max(v) over w as "max" from t5 window w as (partition by p order by o rows between 3 preceding and 0 following);
+------+------+----------+----------+----------+
| p    | o    | v        | min      | max      |
+------+------+----------+----------+----------+
|    4 |    0 | 01:01:04 | 01:01:04 | 01:01:04 |
|    2 |    0 | 03:01:01 | 03:01:01 | 03:01:01 |
|    2 |    1 | 01:01:07 | 01:01:07 | 03:01:01 |
|    2 |    4 | 01:05:01 | 01:01:07 | 03:01:01 |
|    2 |    7 | 02:01:01 | 01:01:07 | 03:01:01 |
|    2 |    8 | 01:05:01 | 01:01:07 | 02:01:01 |
|    2 |   15 | 01:01:05 | 01:01:05 | 02:01:01 |
|    2 |   30 | 41:01:00 | 01:01:05 | 41:01:00 |
|    0 |    0 | 01:01:01 | 01:01:01 | 01:01:01 |
|    5 |    0 | 08:01:01 | 08:01:01 | 08:01:01 |
|    1 |    0 | 01:04:01 | 01:04:01 | 01:04:01 |
|    1 |    1 | 01:02:01 | 01:02:01 | 01:04:01 |
|    1 |    3 | 05:01:01 | 01:02:01 | 05:01:01 |
|    1 |    6 | 01:01:03 | 01:01:03 | 05:01:01 |
|    1 |    7 | 01:02:01 | 01:01:03 | 05:01:01 |
|    1 |    8 | 06:01:01 | 01:01:03 | 06:01:01 |
|    1 |   18 | 04:01:01 | 01:01:03 | 06:01:01 |
|    1 |   30 | 01:04:01 | 01:02:01 | 06:01:01 |
|    3 |    0 | 01:07:01 | 01:07:01 | 01:07:01 |
|    3 |    4 | 01:01:08 | 01:01:08 | 01:07:01 |
|    3 |    6 | 05:01:01 | 01:01:08 | 05:01:01 |
|    3 |   10 | 01:08:01 | 01:01:08 | 05:01:01 |
|    3 |   20 | 01:01:06 | 01:01:06 | 05:01:01 |
|    3 |   40 | 04:01:01 | 01:01:06 | 05:01:01 |
|    3 |   41 | 01:07:01 | 01:01:06 | 04:01:01 |
|    7 |    0 | 01:01:05 | 01:01:05 | 01:01:05 |
|    7 |    1 | 01:06:01 | 01:01:05 | 01:06:01 |
|    7 |    2 | 08:01:01 | 01:01:05 | 08:01:01 |
|    7 |    3 | 01:01:05 | 01:01:05 | 08:01:01 |
|    7 |    4 | 01:04:01 | 01:01:05 | 08:01:01 |
|    6 |    0 | 01:01:06 | 01:01:06 | 01:01:06 |
|    6 |   10 | 01:04:01 | 01:01:06 | 01:04:01 |
|    6 |   30 | 02:01:01 | 01:01:06 | 02:01:01 |
+------+------+----------+----------+----------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, min(v) over w as "min", max(v) over w as "max" from t5 window w as (partition by p order by o rows between 3 preceding and 1 following);
+------+------+----------+----------+----------+
| p    | o    | v        | min      | max      |
+------+------+----------+----------+----------+
|    4 |    0 | 01:01:04 | 01:01:04 | 01:01:04 |
|    0 |    0 | 01:01:01 | 01:01:01 | 01:01:01 |
|    5 |    0 | 08:01:01 | 08:01:01 | 08:01:01 |
|    2 |    0 | 03:01:01 | 01:01:07 | 03:01:01 |
|    2 |    1 | 01:01:07 | 01:01:07 | 03:01:01 |
|    2 |    4 | 01:05:01 | 01:01:07 | 03:01:01 |
|    2 |    7 | 02:01:01 | 01:01:07 | 03:01:01 |
|    2 |    8 | 01:05:01 | 01:01:05 | 02:01:01 |
|    2 |   15 | 01:01:05 | 01:01:05 | 41:01:00 |
|    2 |   30 | 41:01:00 | 01:01:05 | 41:01:00 |
|    1 |    0 | 01:04:01 | 01:02:01 | 01:04:01 |
|    1 |    1 | 01:02:01 | 01:02:01 | 05:01:01 |
|    1 |    3 | 05:01:01 | 01:01:03 | 05:01:01 |
|    1 |    6 | 01:01:03 | 01:01:03 | 05:01:01 |
|    1 |    7 | 01:02:01 | 01:01:03 | 06:01:01 |
|    1 |    8 | 06:01:01 | 01:01:03 | 06:01:01 |
|    1 |   18 | 04:01:01 | 01:01:03 | 06:01:01 |
|    1 |   30 | 01:04:01 | 01:02:01 | 06:01:01 |
|    3 |    0 | 01:07:01 | 01:01:08 | 01:07:01 |
|    3 |    4 | 01:01:08 | 01:01:08 | 05:01:01 |
|    3 |    6 | 05:01:01 | 01:01:08 | 05:01:01 |
|    3 |   10 | 01:08:01 | 01:01:06 | 05:01:01 |
|    3 |   20 | 01:01:06 | 01:01:06 | 05:01:01 |
|    3 |   40 | 04:01:01 | 01:01:06 | 05:01:01 |
|    3 |   41 | 01:07:01 | 01:01:06 | 04:01:01 |
|    6 |    0 | 01:01:06 | 01:01:06 | 01:04:01 |
|    6 |   10 | 01:04:01 | 01:01:06 | 02:01:01 |
|    6 |   30 | 02:01:01 | 01:01:06 | 02:01:01 |
|    7 |    0 | 01:01:05 | 01:01:05 | 01:06:01 |
|    7 |    1 | 01:06:01 | 01:01:05 | 08:01:01 |
|    7 |    2 | 08:01:01 | 01:01:05 | 08:01:01 |
|    7 |    3 | 01:01:05 | 01:01:05 | 08:01:01 |
|    7 |    4 | 01:04:01 | 01:01:05 | 08:01:01 |
+------+------+----------+----------+----------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 1 preceding and 1 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    2 |    0 |   2 |    2 |     2 |    0 |    2 |
|    2 |    1 |   0 |   -2 |     3 |   -4 |    2 |
|    2 |    4 |  -4 |   -6 |     3 |   -4 |    0 |
|    2 |    7 |  -2 |   -5 |     3 |   -4 |    1 |
|    2 |    8 |   1 |    1 |     3 |   -2 |    2 |
|    2 |   15 |   2 |   -8 |     3 |  -11 |    2 |
|    2 |   30 | -11 |   -9 |     2 |  -11 |    2 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    3 |    0 |   7 |    4 |     2 |   -3 |    7 |
|    3 |    4 |  -3 |   13 |     3 |   -3 |    9 |
|    3 |    6 |   9 |   -3 |     3 |   -9 |    9 |
|    3 |   10 |  -9 |   -3 |     3 |   -9 |    9 |
|    3 |   20 |  -3 |  -10 |     3 |   -9 |    2 |
|    3 |   40 |   2 |    0 |     3 |   -3 |    2 |
|    3 |   41 |   1 |    3 |     2 |    1 |    2 |
|    6 |    0 |   2 |    7 |     2 |    2 |    5 |
|    6 |   10 |   5 |    7 |     3 |    0 |    5 |
|    6 |   30 |   0 |    5 |     2 |    0 |    5 |
|    1 |    0 |  -1 |   -1 |     2 |   -1 |    0 |
|    1 |    1 |   0 |    3 |     3 |   -1 |    4 |
|    1 |    3 |   4 |   10 |     3 |    0 |    6 |
|    1 |    6 |   6 |    5 |     3 |   -5 |    6 |
|    1 |    7 |  -5 |    4 |     3 |   -5 |    6 |
|    1 |    8 |   3 |   -1 |     3 |   -5 |    3 |
|    1 |   18 |   1 |   34 |     3 |    1 |   30 |
|    1 |   30 |  30 |   31 |     2 |    1 |   30 |
|    7 |    0 |   3 |    6 |     2 |    3 |    3 |
|    7 |    1 |   3 |    8 |     3 |    2 |    3 |
|    7 |    2 |   2 |    1 |     3 |   -4 |    3 |
|    7 |    3 |  -4 |    7 |     3 |   -4 |    9 |
|    7 |    4 |   9 |    5 |     2 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 1 preceding and 1 following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    2 |    0 |   2 |    2 |     2 |    0 |    2 |
|    2 |    1 |   0 |   -2 |     3 |   -4 |    2 |
|    2 |    4 |  -4 |   -6 |     3 |   -4 |    0 |
|    2 |    7 |  -2 |   -5 |     3 |   -4 |    1 |
|    2 |    8 |   1 |    1 |     3 |   -2 |    2 |
|    2 |   15 |   2 |   -8 |     3 |  -11 |    2 |
|    2 |   30 | -11 |   -9 |     2 |  -11 |    2 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    3 |    0 |   7 |    4 |     2 |   -3 |    7 |
|    3 |    4 |  -3 |   13 |     3 |   -3 |    9 |
|    3 |    6 |   9 |   -3 |     3 |   -9 |    9 |
|    3 |   10 |  -9 |   -3 |     3 |   -9 |    9 |
|    3 |   20 |  -3 |  -10 |     3 |   -9 |    2 |
|    3 |   40 |   2 |    0 |     3 |   -3 |    2 |
|    3 |   41 |   1 |    3 |     2 |    1 |    2 |
|    1 |    0 |  -1 |   -1 |     2 |   -1 |    0 |
|    1 |    1 |   0 |    3 |     3 |   -1 |    4 |
|    1 |    3 |   4 |   10 |     3 |    0 |    6 |
|    1 |    6 |   6 |    5 |     3 |   -5 |    6 |
|    1 |    7 |  -5 |    4 |     3 |   -5 |    6 |
|    1 |    8 |   3 |   -1 |     3 |   -5 |    3 |
|    1 |   18 |   1 |   34 |     3 |    1 |   30 |
|    1 |   30 |  30 |   31 |     2 |    1 |   30 |
|    6 |    0 |   2 |    7 |     2 |    2 |    5 |
|    6 |   10 |   5 |    7 |     3 |    0 |    5 |
|    6 |   30 |   0 |    5 |     2 |    0 |    5 |
|    7 |    0 |   3 |    6 |     2 |    3 |    3 |
|    7 |    1 |   3 |    8 |     3 |    2 |    3 |
|    7 |    2 |   2 |    1 |     3 |   -4 |    3 |
|    7 |    3 |  -4 |    7 |     3 |   -4 |    9 |
|    7 |    4 |   9 |    5 |     2 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between current row and unbounded following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    2 |    0 |   2 |  -12 |     7 |  -11 |    2 |
|    2 |    1 |   0 |  -14 |     6 |  -11 |    2 |
|    2 |    4 |  -4 |  -14 |     5 |  -11 |    2 |
|    2 |    7 |  -2 |  -10 |     4 |  -11 |    2 |
|    2 |    8 |   1 |   -8 |     3 |  -11 |    2 |
|    2 |   15 |   2 |   -9 |     2 |  -11 |    2 |
|    2 |   30 | -11 |  -11 |     1 |  -11 |  -11 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    3 |    0 |   7 |    4 |     7 |   -9 |    9 |
|    3 |    4 |  -3 |   -3 |     6 |   -9 |    9 |
|    3 |    6 |   9 |    0 |     5 |   -9 |    9 |
|    3 |   10 |  -9 |   -9 |     4 |   -9 |    2 |
|    3 |   20 |  -3 |    0 |     3 |   -3 |    2 |
|    3 |   40 |   2 |    3 |     2 |    1 |    2 |
|    3 |   41 |   1 |    1 |     1 |    1 |    1 |
|    1 |    0 |  -1 |   38 |     8 |   -5 |   30 |
|    1 |    1 |   0 |   39 |     7 |   -5 |   30 |
|    1 |    3 |   4 |   39 |     6 |   -5 |   30 |
|    1 |    6 |   6 |   35 |     5 |   -5 |   30 |
|    1 |    7 |  -5 |   29 |     4 |   -5 |   30 |
|    1 |    8 |   3 |   34 |     3 |    1 |   30 |
|    1 |   18 |   1 |   31 |     2 |    1 |   30 |
|    1 |   30 |  30 |   30 |     1 |   30 |   30 |
|    6 |    0 |   2 |    7 |     3 |    0 |    5 |
|    6 |   10 |   5 |    5 |     2 |    0 |    5 |
|    6 |   30 |   0 |    0 |     1 |    0 |    0 |
|    7 |    0 |   3 |   13 |     5 |   -4 |    9 |
|    7 |    1 |   3 |   10 |     4 |   -4 |    9 |
|    7 |    2 |   2 |    7 |     3 |   -4 |    9 |
|    7 |    3 |  -4 |    5 |     2 |   -4 |    9 |
|    7 |    4 |   9 |    9 |     1 |    9 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between 2 preceding and current row);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -2 |     3 |   -4 |    2 |
|    2 |    7 |  -2 |   -6 |     3 |   -4 |    0 |
|    2 |    8 |   1 |   -5 |     3 |   -4 |    1 |
|    2 |   15 |   2 |    1 |     3 |   -2 |    2 |
|    2 |   30 | -11 |   -8 |     3 |  -11 |    2 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    3 |     3 |   -1 |    4 |
|    1 |    6 |   6 |   10 |     3 |    0 |    6 |
|    1 |    7 |  -5 |    5 |     3 |   -5 |    6 |
|    1 |    8 |   3 |    4 |     3 |   -5 |    6 |
|    1 |   18 |   1 |   -1 |     3 |   -5 |    3 |
|    1 |   30 |  30 |   34 |     3 |    1 |   30 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |    4 |     2 |   -3 |    7 |
|    3 |    6 |   9 |   13 |     3 |   -3 |    9 |
|    3 |   10 |  -9 |   -3 |     3 |   -9 |    9 |
|    3 |   20 |  -3 |   -3 |     3 |   -9 |    9 |
|    3 |   40 |   2 |  -10 |     3 |   -9 |    2 |
|    3 |   41 |   1 |    0 |     3 |   -3 |    2 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |    3 |    3 |
|    7 |    2 |   2 |    8 |     3 |    2 |    3 |
|    7 |    3 |  -4 |    1 |     3 |   -4 |    3 |
|    7 |    4 |   9 |    7 |     3 |   -4 |    9 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    7 |     2 |    2 |    5 |
|    6 |   30 |   0 |    7 |     3 |    0 |    5 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between unbounded preceding and current row);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    2 |    0 |   2 |    2 |     1 |    2 |    2 |
|    2 |    1 |   0 |    2 |     2 |    0 |    2 |
|    2 |    4 |  -4 |   -2 |     3 |   -4 |    2 |
|    2 |    7 |  -2 |   -4 |     4 |   -4 |    2 |
|    2 |    8 |   1 |   -3 |     5 |   -4 |    2 |
|    2 |   15 |   2 |   -1 |     6 |   -4 |    2 |
|    2 |   30 | -11 |  -12 |     7 |  -11 |    2 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    3 |    0 |   7 |    7 |     1 |    7 |    7 |
|    3 |    4 |  -3 |    4 |     2 |   -3 |    7 |
|    3 |    6 |   9 |   13 |     3 |   -3 |    9 |
|    3 |   10 |  -9 |    4 |     4 |   -9 |    9 |
|    3 |   20 |  -3 |    1 |     5 |   -9 |    9 |
|    3 |   40 |   2 |    3 |     6 |   -9 |    9 |
|    3 |   41 |   1 |    4 |     7 |   -9 |    9 |
|    1 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    1 |    1 |   0 |   -1 |     2 |   -1 |    0 |
|    1 |    3 |   4 |    3 |     3 |   -1 |    4 |
|    1 |    6 |   6 |    9 |     4 |   -1 |    6 |
|    1 |    7 |  -5 |    4 |     5 |   -5 |    6 |
|    1 |    8 |   3 |    7 |     6 |   -5 |    6 |
|    1 |   18 |   1 |    8 |     7 |   -5 |    6 |
|    1 |   30 |  30 |   38 |     8 |   -5 |   30 |
|    6 |    0 |   2 |    2 |     1 |    2 |    2 |
|    6 |   10 |   5 |    7 |     2 |    2 |    5 |
|    6 |   30 |   0 |    7 |     3 |    0 |    5 |
|    7 |    0 |   3 |    3 |     1 |    3 |    3 |
|    7 |    1 |   3 |    6 |     2 |    3 |    3 |
|    7 |    2 |   2 |    8 |     3 |    2 |    3 |
|    7 |    3 |  -4 |    4 |     4 |   -4 |    3 |
|    7 |    4 |   9 |   13 |     5 |   -4 |    9 |
+------+------+-----+------+-------+------+------+

mysql> use test; set tidb_enforce_mpp=1; select p, o, v, sum(v) over w as "sum", count(v) over w as "count", min(v) over w as "min", max(v) over w as "max" from t1 window w as (partition by p order by o rows between unbounded preceding and unbounded following);
+------+------+-----+------+-------+------+------+
| p    | o    | v   | sum  | count | min  | max  |
+------+------+-----+------+-------+------+------+
|    4 |    0 |   4 |    4 |     1 |    4 |    4 |
|    0 |    0 |  -1 |   -1 |     1 |   -1 |   -1 |
|    5 |    0 |  -5 |   -5 |     1 |   -5 |   -5 |
|    3 |    0 |   7 |    4 |     7 |   -9 |    9 |
|    3 |    4 |  -3 |    4 |     7 |   -9 |    9 |
|    3 |    6 |   9 |    4 |     7 |   -9 |    9 |
|    3 |   10 |  -9 |    4 |     7 |   -9 |    9 |
|    3 |   20 |  -3 |    4 |     7 |   -9 |    9 |
|    3 |   40 |   2 |    4 |     7 |   -9 |    9 |
|    3 |   41 |   1 |    4 |     7 |   -9 |    9 |
|    6 |    0 |   2 |    7 |     3 |    0 |    5 |
|    6 |   10 |   5 |    7 |     3 |    0 |    5 |
|    6 |   30 |   0 |    7 |     3 |    0 |    5 |
|    7 |    0 |   3 |   13 |     5 |   -4 |    9 |
|    7 |    1 |   3 |   13 |     5 |   -4 |    9 |
|    7 |    2 |   2 |   13 |     5 |   -4 |    9 |
|    7 |    3 |  -4 |   13 |     5 |   -4 |    9 |
|    7 |    4 |   9 |   13 |     5 |   -4 |    9 |
|    2 |    0 |   2 |  -12 |     7 |  -11 |    2 |
|    2 |    1 |   0 |  -12 |     7 |  -11 |    2 |
|    2 |    4 |  -4 |  -12 |     7 |  -11 |    2 |
|    2 |    7 |  -2 |  -12 |     7 |  -11 |    2 |
|    2 |    8 |   1 |  -12 |     7 |  -11 |    2 |
|    2 |   15 |   2 |  -12 |     7 |  -11 |    2 |
|    2 |   30 | -11 |  -12 |     7 |  -11 |    2 |
|    1 |    0 |  -1 |   38 |     8 |   -5 |   30 |
|    1 |    1 |   0 |   38 |     8 |   -5 |   30 |
|    1 |    3 |   4 |   38 |     8 |   -5 |   30 |
|    1 |    6 |   6 |   38 |     8 |   -5 |   30 |
|    1 |    7 |  -5 |   38 |     8 |   -5 |   30 |
|    1 |    8 |   3 |   38 |     8 |   -5 |   30 |
|    1 |   18 |   1 |   38 |     8 |   -5 |   30 |
|    1 |   30 |  30 |   38 |     8 |   -5 |   30 |
+------+------+-----+------+-------+------+------+
