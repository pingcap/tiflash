# Copyright 2025 PingCAP, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# truncate(col_double, col_int)
mysql> drop table if exists test.t1;
mysql> create table test.t1(c1 double, c2 bigint);
mysql> alter table test.t1 set tiflash replica 1;
mysql> insert into test.t1 values(-1.23, 0), (1.58, 0), (1.298, 1), (123.2, -1), (123.2, 100), (123.2, -100), (123.2, -100), (1.797693134862315708145274237317043567981e+308, 2), (Null, 2), (1.1, 400), (1.1, -400), (0, 400), (0, -400), (1.1, 3), (0, 3), (99.99, 1), (99.99, -1), (-99.99, 1), (-99.99, -1), (0.0001, 3), (0.0001, -3);
func> wait_table test t1
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, c2, truncate(c1, c2) from test.t1 order by 1, 2, 3;
+------------------------+------+------------------------+
| c1                     | c2   | truncate(c1, c2)       |
+------------------------+------+------------------------+
|                   NULL |    2 |                   NULL |
|                 -99.99 |   -1 |                    -90 |
|                 -99.99 |    1 |                  -99.9 |
|                  -1.23 |    0 |                     -1 |
|                      0 | -400 |                      0 |
|                      0 |    3 |                      0 |
|                      0 |  400 |                      0 |
|                 0.0001 |   -3 |                      0 |
|                 0.0001 |    3 |                      0 |
|                    1.1 | -400 |                      0 |
|                    1.1 |    3 |                    1.1 |
|                    1.1 |  400 |                    1.1 |
|                  1.298 |    1 |                    1.2 |
|                   1.58 |    0 |                      1 |
|                  99.99 |   -1 |                     90 |
|                  99.99 |    1 |                   99.9 |
|                  123.2 | -100 |                      0 |
|                  123.2 | -100 |                      0 |
|                  123.2 |   -1 |                    120 |
|                  123.2 |  100 |                  123.2 |
| 1.7976931348623157e308 |    2 | 1.7976931348623157e308 |
+------------------------+------+------------------------+

# truncate(col_str, col_int)
mysql> drop table if exists test.t2;
mysql> create table test.t2(c1 varchar(100), c2 bigint);
mysql> insert into test.t2 values("-1.23", 0), ("-1.23", 1), ("-11.23", -1), ("1.58", 0), ("1.58", 1), ("11.58", -1), ("23.298", -1), ("23.298", -100), ("23.298", 100);
mysql> alter table test.t2 set tiflash replica 1;
func> wait_table test t2
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, c2, truncate(c1, c2) from test.t2 order by 1, 2, 3;
+--------+------+------------------+
| c1     | c2   | truncate(c1, c2) |
+--------+------+------------------+
| -1.23  |    0 |               -1 |
| -1.23  |    1 |             -1.2 |
| -11.23 |   -1 |              -10 |
| 1.58   |    0 |                1 |
| 1.58   |    1 |              1.5 |
| 11.58  |   -1 |               10 |
| 23.298 | -100 |                0 |
| 23.298 |   -1 |               20 |
| 23.298 |  100 |           23.298 |
+--------+------+------------------+

# truncate(col_bigint_unsigned, col_int)
mysql> drop table if exists test.t3;
mysql> create table test.t3(c1 bigint unsigned);
mysql> alter table test.t3 set tiflash replica 1;
mysql> insert into test.t3 values(9223372036854775808), (18446744073709551615);
func> wait_table test t3
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, truncate(c1, -10) from test.t3 order by 1, 2;
+----------------------+----------------------+
| c1                   | truncate(c1, -10)    |
+----------------------+----------------------+
|  9223372036854775808 |  9223372030000000000 |
| 18446744073709551615 | 18446744070000000000 |
+----------------------+----------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, truncate(c1, -7) from test.t3 order by 1, 2;
+----------------------+----------------------+
| c1                   | truncate(c1, -7)     |
+----------------------+----------------------+
|  9223372036854775808 |  9223372036850000000 |
| 18446744073709551615 | 18446744073700000000 |
+----------------------+----------------------+

# truncate(col_bigint_signed, col_int)
mysql> drop table if exists test.t3_1;
mysql> create table test.t3_1(c1 bigint);
mysql> alter table test.t3_1 set tiflash replica 1;
mysql> insert into test.t3_1 values(-9223372036854775808), (9223372036854775807);
func> wait_table test t3_1
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, truncate(c1, -10) from test.t3_1 order by 1, 2;
+----------------------+----------------------+
| c1                   | truncate(c1, -10)    |
+----------------------+----------------------+
| -9223372036854775808 | -9223372030000000000 |
|  9223372036854775807 |  9223372030000000000 |
+----------------------+----------------------+

# # truncate(col_decimal, col_int)
# mysql> drop table if exists test.t4;
# mysql> create table test.t4(c1 decimal(10, 5), c2 bigint);
# mysql> insert into test.t4 values(-1.23, 0), (1.58, 0), (1.298, 1), (123.2, -1), (123.2, 100), (123.2, -100), (123.2, -100), (Null, 2), (1.1, 400), (1.1, -400), (0, 400), (0, -400), (1.1, 3), (0, 3), (99.99, 1), (99.99, -1), (-99.99, 1), (-99.99, -1), (0.0001, 3), (0.0001, -3);
# mysql> alter table test.t4 set tiflash replica 1;
# func> wait_table test t4
# # todo tidb result
# # +-----------+------+------------------+
# # | c1        | c2   | truncate(c1, c2) |
# # +-----------+------+------------------+
# # |      NULL |    2 |             NULL |
# # | -99.99000 |   -1 |              -90 |
# # | -99.99000 |    1 |            -99.9 |
# # |  -1.23000 |    0 |               -1 |
# # |   0.00000 | -400 |                0 |
# # |   0.00000 |    3 |            0.000 |
# # |   0.00000 |  400 |          0.00000 |
# # |   0.00010 |   -3 |                0 |
# # |   0.00010 |    3 |            0.000 |
# # |   1.10000 | -400 |                0 |
# # |   1.10000 |    3 |            1.100 |
# # |   1.10000 |  400 |          1.10000 |
# # |   1.29800 |    1 |              1.2 |
# # |   1.58000 |    0 |                1 |
# # |  99.99000 |   -1 |               90 |
# # |  99.99000 |    1 |             99.9 |
# # | 123.20000 | -100 |                0 |
# # | 123.20000 | -100 |                0 |
# # | 123.20000 |   -1 |              120 |
# # | 123.20000 |  100 |        123.20000 |
# # +-----------+------+------------------+
# mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select c1, c2, truncate(c1, c2) from test.t4 order by 1, 2, 3;
# +-----------+------+------------------+
# | c1        | c2   | truncate(c1, c2) |
# +-----------+------+------------------+
# |      NULL |    2 |             NULL |
# | -99.99000 |   -1 |        -90.00000 |
# | -99.99000 |    1 |        -99.90000 |
# |  -1.23000 |    0 |         -1.00000 |
# |   0.00000 | -400 |          0.00000 |
# |   0.00000 |    3 |          0.00000 |
# |   0.00000 |  400 |          0.00000 |
# |   0.00010 |   -3 |          0.00000 |
# |   0.00010 |    3 |          0.00000 |
# |   1.10000 | -400 |          0.00000 |
# |   1.10000 |    3 |          1.10000 |
# |   1.10000 |  400 |          1.10000 |
# |   1.29800 |    1 |          1.20000 |
# |   1.58000 |    0 |          1.00000 |
# |  99.99000 |   -1 |         90.00000 |
# |  99.99000 |    1 |         99.90000 |
# | 123.20000 | -100 |          0.00000 |
# | 123.20000 | -100 |          0.00000 |
# | 123.20000 |   -1 |        120.00000 |
# | 123.20000 |  100 |        123.20000 |
# +-----------+------+------------------+

# case copied from round_with_frac.test
mysql> drop table if exists test.f32
mysql> create table test.f32 (id bigint, a float)
mysql> alter table test.f32 set tiflash replica 1
mysql> insert into test.f32 values (1, 0), (2, 2.5), (3, -2.5), (4, 0.25), (5, -0.25), (6, 0.25e-10), (7, -0.25e-10), (8, 49e10), (9, 50e10), (10, -49e10), (11, -50e10), (12, 0.3), (13, null)

mysql> drop table if exists test.f64
mysql> create table test.f64 (id bigint, a double)
mysql> alter table test.f64 set tiflash replica 1
mysql> insert into test.f64 values (1, 0), (2, 2.5), (3, -2.5), (4, 0.25), (5, -0.25), (6, 0.25e-10), (7, -0.25e-10), (8, 49e10), (9, 50e10), (10, -49e10), (11, -50e10), (12, 0.3), (13, null)

mysql> drop table if exists test.d9
mysql> create table test.d9 (id bigint, a decimal(9, 4))
mysql> alter table test.d9 set tiflash replica 1
mysql> insert into test.d9 values (1, 0), (2, 0.25), (3, -0.25), (4, 0.0499), (5, 0.05), (6, -0.0499), (7, -0.05), (8, 49999.9999), (9, 50000), (10, -49999.9999), (11, -50000), (12, 99999.9999), (13, -99999.9999), (14, 25), (15, -25), (16, null)

mysql> drop table if exists test.d64
mysql> create table test.d64 (id bigint, a decimal(64, 2))
mysql> alter table test.d64 set tiflash replica 1
mysql> insert into test.d64 values (1, 0), (2, 0.25), (3, -0.25), (4, 25), (5, -25), (6, 49999999999999999999999999999999999999999999999999999999999999.99), (7, 50000000000000000000000000000000000000000000000000000000000000), (8, -49999999999999999999999999999999999999999999999999999999999999.99), (9, -50000000000000000000000000000000000000000000000000000000000000), (10, 0.49), (11, 0.5), (12, -0.49), (13, -0.5), (14, 99999999999999999999999999999999999999999999999999999999999999.99), (15, -99999999999999999999999999999999999999999999999999999999999999.99), (16, null)

mysql> drop table if exists test.t
mysql> create table test.t (i bigint)
mysql> alter table test.t set tiflash replica 1
mysql> insert into test.t values (-66), (-65), (-64), (-63), (-62), (-61), (-60), (-59), (-58), (-57), (-56), (-55), (-54), (-53), (-52), (-51), (-50), (-49), (-48), (-47), (-46), (-45), (-44), (-43), (-42), (-41), (-40), (-39), (-38), (-37), (-36), (-35), (-34), (-33), (-32), (-31), (-30), (-29), (-28), (-27), (-26), (-25), (-24), (-23), (-22), (-21), (-20), (-19), (-18), (-17), (-16), (-15), (-14), (-13), (-12), (-11), (-10), (-9), (-8), (-7), (-6), (-5), (-4), (-3), (-2), (-1), (0), (1), (2), (3), (4), (5), (6), (7), (8), (9), (10), (11), (12), (13), (14), (15), (16), (17), (18), (19), (20), (21), (22), (23), (24), (25), (26), (27), (28), (29), (30), (31), (9223372036854775807), (-9223372036854775808)

# func> wait_table test i8 u8 i32 u32 i64 u64
func> wait_table test f32 f64 d9 d64 t

# const frac
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 2)), sum(truncate(a, 1)), sum(truncate(a, 0)), sum(truncate(a, -1)), sum(truncate(a, -2)) from test.f32 group by id order by id
+------------------------------+---------------------+---------------------+---------------------+----------------------+----------------------+
| sum(a)                       | sum(truncate(a, 2)) | sum(truncate(a, 1)) | sum(truncate(a, 0)) | sum(truncate(a, -1)) | sum(truncate(a, -2)) |
+------------------------------+---------------------+---------------------+---------------------+----------------------+----------------------+
|                            0 |                   0 |                   0 |                   0 |                    0 |                    0 |
|                          2.5 |                 2.5 |                 2.5 |                   2 |                    0 |                    0 |
|                         -2.5 |                -2.5 |                -2.5 |                  -2 |                    0 |                    0 |
|                         0.25 |                0.25 |                 0.2 |                   0 |                    0 |                    0 |
|                        -0.25 |               -0.25 |                -0.2 |                   0 |                    0 |                    0 |
|  0.0000000000250000003337858 |                   0 |                   0 |                   0 |                    0 |                    0 |
| -0.0000000000250000003337858 |                   0 |                   0 |                   0 |                    0 |                    0 |
|                 489999990784 |        489999990784 |        489999990784 |        489999990784 |         489999990780 |         489999990700 |
|                 499999997952 |        499999997952 |        499999997952 |        499999997952 |         499999997950 |         499999997900 |
|                -489999990784 |       -489999990784 |       -489999990784 |       -489999990784 |        -489999990780 |        -489999990700 |
|                -499999997952 |       -499999997952 |       -499999997952 |       -499999997952 |        -499999997950 |        -499999997900 |
|          0.30000001192092896 |                 0.3 |                 0.3 |                   0 |                    0 |                    0 |
|                         NULL |                NULL |                NULL |                NULL |                 NULL |                 NULL |
+------------------------------+---------------------+---------------------+---------------------+----------------------+----------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 8)), sum(truncate(a, 9)), sum(truncate(a, -9)), sum(truncate(a, -10)) from test.f32 group by id order by id
+------------------------------+---------------------+---------------------+----------------------+-----------------------+
| sum(a)                       | sum(truncate(a, 8)) | sum(truncate(a, 9)) | sum(truncate(a, -9)) | sum(truncate(a, -10)) |
+------------------------------+---------------------+---------------------+----------------------+-----------------------+
|                            0 |                   0 |                   0 |                    0 |                     0 |
|                          2.5 |                 2.5 |                 2.5 |                    0 |                     0 |
|                         -2.5 |                -2.5 |                -2.5 |                    0 |                     0 |
|                         0.25 |                0.25 |                0.25 |                    0 |                     0 |
|                        -0.25 |               -0.25 |               -0.25 |                    0 |                     0 |
|  0.0000000000250000003337858 |                   0 |                   0 |                    0 |                     0 |
| -0.0000000000250000003337858 |                   0 |                   0 |                    0 |                     0 |
|                 489999990784 |        489999990784 |        489999990784 |         489000000000 |          480000000000 |
|                 499999997952 |        499999997952 |        499999997952 |   498999999999.99994 |          490000000000 |
|                -489999990784 |       -489999990784 |       -489999990784 |        -489000000000 |         -480000000000 |
|                -499999997952 |       -499999997952 |       -499999997952 |  -498999999999.99994 |         -490000000000 |
|          0.30000001192092896 |          0.30000001 |         0.300000011 |                    0 |                     0 |
|                         NULL |                NULL |                NULL |                 NULL |                  NULL |
+------------------------------+---------------------+---------------------+----------------------+-----------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 30)), sum(truncate(a, -30)), sum(truncate(a, 1000000)), sum(truncate(a, -1000000)) from test.f32 group by id order by id
+------------------------------+------------------------------+-----------------------+------------------------------+----------------------------+
| sum(a)                       | sum(truncate(a, 30))         | sum(truncate(a, -30)) | sum(truncate(a, 1000000))    | sum(truncate(a, -1000000)) |
+------------------------------+------------------------------+-----------------------+------------------------------+----------------------------+
|                            0 |                            0 |                     0 |                            0 |                          0 |
|                          2.5 |                          2.5 |                     0 |                          2.5 |                          0 |
|                         -2.5 |                         -2.5 |                     0 |                         -2.5 |                          0 |
|                         0.25 |                         0.25 |                     0 |                         0.25 |                          0 |
|                        -0.25 |                        -0.25 |                     0 |                        -0.25 |                          0 |
|  0.0000000000250000003337858 |  0.0000000000250000003337858 |                     0 |  0.0000000000250000003337858 |                          0 |
| -0.0000000000250000003337858 | -0.0000000000250000003337858 |                     0 | -0.0000000000250000003337858 |                          0 |
|                 489999990784 |                 489999990784 |                     0 |                 489999990784 |                          0 |
|                 499999997952 |                 499999997952 |                     0 |                 499999997952 |                          0 |
|                -489999990784 |                -489999990784 |                     0 |                -489999990784 |                          0 |
|                -499999997952 |                -499999997952 |                     0 |                -499999997952 |                          0 |
|          0.30000001192092896 |          0.30000001192092896 |                     0 |          0.30000001192092896 |                          0 |
|                         NULL |                         NULL |                  NULL |                         NULL |                       NULL |
+------------------------------+------------------------------+-----------------------+------------------------------+----------------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 2)), sum(truncate(a, 1)), sum(truncate(a, 0)), sum(truncate(a, -1)), sum(truncate(a, -2)) from test.f64 group by id order by id
+-----------------+---------------------+---------------------+---------------------+----------------------+----------------------+
| sum(a)          | sum(truncate(a, 2)) | sum(truncate(a, 1)) | sum(truncate(a, 0)) | sum(truncate(a, -1)) | sum(truncate(a, -2)) |
+-----------------+---------------------+---------------------+---------------------+----------------------+----------------------+
|               0 |                   0 |                   0 |                   0 |                    0 |                    0 |
|             2.5 |                 2.5 |                 2.5 |                   2 |                    0 |                    0 |
|            -2.5 |                -2.5 |                -2.5 |                  -2 |                    0 |                    0 |
|            0.25 |                0.25 |                 0.2 |                   0 |                    0 |                    0 |
|           -0.25 |               -0.25 |                -0.2 |                   0 |                    0 |                    0 |
|  0.000000000025 |                   0 |                   0 |                   0 |                    0 |                    0 |
| -0.000000000025 |                   0 |                   0 |                   0 |                    0 |                    0 |
|    490000000000 |        490000000000 |        490000000000 |        490000000000 |         490000000000 |         490000000000 |
|    500000000000 |        500000000000 |        500000000000 |        500000000000 |         500000000000 |         500000000000 |
|   -490000000000 |       -490000000000 |       -490000000000 |       -490000000000 |        -490000000000 |        -490000000000 |
|   -500000000000 |       -500000000000 |       -500000000000 |       -500000000000 |        -500000000000 |        -500000000000 |
|             0.3 |                 0.3 |                 0.3 |                   0 |                    0 |                    0 |
|            NULL |                NULL |                NULL |                NULL |                 NULL |                 NULL |
+-----------------+---------------------+---------------------+---------------------+----------------------+----------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 8)), sum(truncate(a, 9)), sum(truncate(a, -9)), sum(truncate(a, -10)) from test.f64 group by id order by id
+-----------------+---------------------+---------------------+----------------------+-----------------------+
| sum(a)          | sum(truncate(a, 8)) | sum(truncate(a, 9)) | sum(truncate(a, -9)) | sum(truncate(a, -10)) |
+-----------------+---------------------+---------------------+----------------------+-----------------------+
|               0 |                   0 |                   0 |                    0 |                     0 |
|             2.5 |                 2.5 |                 2.5 |                    0 |                     0 |
|            -2.5 |                -2.5 |                -2.5 |                    0 |                     0 |
|            0.25 |                0.25 |                0.25 |                    0 |                     0 |
|           -0.25 |               -0.25 |               -0.25 |                    0 |                     0 |
|  0.000000000025 |                   0 |                   0 |                    0 |                     0 |
| -0.000000000025 |                   0 |                   0 |                    0 |                     0 |
|    490000000000 |        490000000000 |        490000000000 |   489999999999.99994 |          490000000000 |
|    500000000000 |        500000000000 |        500000000000 |   499999999999.99994 |          500000000000 |
|   -490000000000 |       -490000000000 |       -490000000000 |  -489999999999.99994 |         -490000000000 |
|   -500000000000 |       -500000000000 |       -500000000000 |  -499999999999.99994 |         -500000000000 |
|             0.3 |                 0.3 |                 0.3 |                    0 |                     0 |
|            NULL |                NULL |                NULL |                 NULL |                  NULL |
+-----------------+---------------------+---------------------+----------------------+-----------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 30)), sum(truncate(a, -30)), sum(truncate(a, 1000000)), sum(truncate(a, -1000000)) from test.f64 group by id order by id
+-----------------+----------------------+-----------------------+---------------------------+----------------------------+
| sum(a)          | sum(truncate(a, 30)) | sum(truncate(a, -30)) | sum(truncate(a, 1000000)) | sum(truncate(a, -1000000)) |
+-----------------+----------------------+-----------------------+---------------------------+----------------------------+
|               0 |                    0 |                     0 |                         0 |                          0 |
|             2.5 |                  2.5 |                     0 |                       2.5 |                          0 |
|            -2.5 |                 -2.5 |                     0 |                      -2.5 |                          0 |
|            0.25 |                 0.25 |                     0 |                      0.25 |                          0 |
|           -0.25 |                -0.25 |                     0 |                     -0.25 |                          0 |
|  0.000000000025 |       0.000000000025 |                     0 |            0.000000000025 |                          0 |
| -0.000000000025 |      -0.000000000025 |                     0 |           -0.000000000025 |                          0 |
|    490000000000 |         490000000000 |                     0 |              490000000000 |                          0 |
|    500000000000 |         500000000000 |                     0 |              500000000000 |                          0 |
|   -490000000000 |        -490000000000 |                     0 |             -490000000000 |                          0 |
|   -500000000000 |        -500000000000 |                     0 |             -500000000000 |                          0 |
|             0.3 |                  0.3 |                     0 |                       0.3 |                          0 |
|            NULL |                 NULL |                  NULL |                      NULL |                       NULL |
+-----------------+----------------------+-----------------------+---------------------------+----------------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, -1)), sum(truncate(a, 0)), sum(truncate(a, 1)) from test.d9 group by id order by id
+-------------+----------------------+---------------------+---------------------+
| sum(a)      | sum(truncate(a, -1)) | sum(truncate(a, 0)) | sum(truncate(a, 1)) |
+-------------+----------------------+---------------------+---------------------+
|      0.0000 |                    0 |                   0 |                 0.0 |
|      0.2500 |                    0 |                   0 |                 0.2 |
|     -0.2500 |                    0 |                   0 |                -0.2 |
|      0.0499 |                    0 |                   0 |                 0.0 |
|      0.0500 |                    0 |                   0 |                 0.0 |
|     -0.0499 |                    0 |                   0 |                 0.0 |
|     -0.0500 |                    0 |                   0 |                 0.0 |
|  49999.9999 |                49990 |               49999 |             49999.9 |
|  50000.0000 |                50000 |               50000 |             50000.0 |
| -49999.9999 |               -49990 |              -49999 |            -49999.9 |
| -50000.0000 |               -50000 |              -50000 |            -50000.0 |
|  99999.9999 |                99990 |               99999 |             99999.9 |
| -99999.9999 |               -99990 |              -99999 |            -99999.9 |
|     25.0000 |                   20 |                  25 |                25.0 |
|    -25.0000 |                  -20 |                 -25 |               -25.0 |
|        NULL |                 NULL |                NULL |                NULL |
+-------------+----------------------+---------------------+---------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 3)), sum(truncate(a, 4)), sum(truncate(a, 5)), sum(truncate(a, 40)) from test.d9 group by id order by id
+-------------+---------------------+---------------------+---------------------+---------------------------------------+
| sum(a)      | sum(truncate(a, 3)) | sum(truncate(a, 4)) | sum(truncate(a, 5)) | sum(truncate(a, 40))                  |
+-------------+---------------------+---------------------+---------------------+---------------------------------------+
|      0.0000 |               0.000 |              0.0000 |             0.00000 |      0.000000000000000000000000000000 |
|      0.2500 |               0.250 |              0.2500 |             0.25000 |      0.250000000000000000000000000000 |
|     -0.2500 |              -0.250 |             -0.2500 |            -0.25000 |     -0.250000000000000000000000000000 |
|      0.0499 |               0.049 |              0.0499 |             0.04990 |      0.049900000000000000000000000000 |
|      0.0500 |               0.050 |              0.0500 |             0.05000 |      0.050000000000000000000000000000 |
|     -0.0499 |              -0.049 |             -0.0499 |            -0.04990 |     -0.049900000000000000000000000000 |
|     -0.0500 |              -0.050 |             -0.0500 |            -0.05000 |     -0.050000000000000000000000000000 |
|  49999.9999 |           49999.999 |          49999.9999 |         49999.99990 |  49999.999900000000000000000000000000 |
|  50000.0000 |           50000.000 |          50000.0000 |         50000.00000 |  50000.000000000000000000000000000000 |
| -49999.9999 |          -49999.999 |         -49999.9999 |        -49999.99990 | -49999.999900000000000000000000000000 |
| -50000.0000 |          -50000.000 |         -50000.0000 |        -50000.00000 | -50000.000000000000000000000000000000 |
|  99999.9999 |           99999.999 |          99999.9999 |         99999.99990 |  99999.999900000000000000000000000000 |
| -99999.9999 |          -99999.999 |         -99999.9999 |        -99999.99990 | -99999.999900000000000000000000000000 |
|     25.0000 |              25.000 |             25.0000 |            25.00000 |     25.000000000000000000000000000000 |
|    -25.0000 |             -25.000 |            -25.0000 |           -25.00000 |    -25.000000000000000000000000000000 |
|        NULL |                NULL |                NULL |                NULL |                                  NULL |
+-------------+---------------------+---------------------+---------------------+---------------------------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, -4)), sum(truncate(a, -5)), sum(truncate(a, -6)), sum(truncate(a, -100)) from test.d9 group by id order by id
+-------------+----------------------+----------------------+----------------------+------------------------+
| sum(a)      | sum(truncate(a, -4)) | sum(truncate(a, -5)) | sum(truncate(a, -6)) | sum(truncate(a, -100)) |
+-------------+----------------------+----------------------+----------------------+------------------------+
|      0.0000 |                    0 |                    0 |                    0 |                      0 |
|      0.2500 |                    0 |                    0 |                    0 |                      0 |
|     -0.2500 |                    0 |                    0 |                    0 |                      0 |
|      0.0499 |                    0 |                    0 |                    0 |                      0 |
|      0.0500 |                    0 |                    0 |                    0 |                      0 |
|     -0.0499 |                    0 |                    0 |                    0 |                      0 |
|     -0.0500 |                    0 |                    0 |                    0 |                      0 |
|  49999.9999 |                40000 |                    0 |                    0 |                      0 |
|  50000.0000 |                50000 |                    0 |                    0 |                      0 |
| -49999.9999 |               -40000 |                    0 |                    0 |                      0 |
| -50000.0000 |               -50000 |                    0 |                    0 |                      0 |
|  99999.9999 |                90000 |                    0 |                    0 |                      0 |
| -99999.9999 |               -90000 |                    0 |                    0 |                      0 |
|     25.0000 |                    0 |                    0 |                    0 |                      0 |
|    -25.0000 |                    0 |                    0 |                    0 |                      0 |
|        NULL |                 NULL |                 NULL |                 NULL |                   NULL |
+-------------+----------------------+----------------------+----------------------+------------------------+

mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, -1)), sum(truncate(a, 0)), sum(truncate(a, 1)) from test.d64 group by id order by id
+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------------------------------------------------+-------------------------------------------------------------------+
| sum(a)                                                             | sum(truncate(a, -1))                                            | sum(truncate(a, 0))                                             | sum(truncate(a, 1))                                               |
+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------------------------------------------------+-------------------------------------------------------------------+
|                                                               0.00 |                                                               0 |                                                               0 |                                                               0.0 |
|                                                               0.25 |                                                               0 |                                                               0 |                                                               0.2 |
|                                                              -0.25 |                                                               0 |                                                               0 |                                                              -0.2 |
|                                                              25.00 |                                                              20 |                                                              25 |                                                              25.0 |
|                                                             -25.00 |                                                             -20 |                                                             -25 |                                                             -25.0 |
|  49999999999999999999999999999999999999999999999999999999999999.99 |  49999999999999999999999999999999999999999999999999999999999990 |  49999999999999999999999999999999999999999999999999999999999999 |  49999999999999999999999999999999999999999999999999999999999999.9 |
|  50000000000000000000000000000000000000000000000000000000000000.00 |  50000000000000000000000000000000000000000000000000000000000000 |  50000000000000000000000000000000000000000000000000000000000000 |  50000000000000000000000000000000000000000000000000000000000000.0 |
| -49999999999999999999999999999999999999999999999999999999999999.99 | -49999999999999999999999999999999999999999999999999999999999990 | -49999999999999999999999999999999999999999999999999999999999999 | -49999999999999999999999999999999999999999999999999999999999999.9 |
| -50000000000000000000000000000000000000000000000000000000000000.00 | -50000000000000000000000000000000000000000000000000000000000000 | -50000000000000000000000000000000000000000000000000000000000000 | -50000000000000000000000000000000000000000000000000000000000000.0 |
|                                                               0.49 |                                                               0 |                                                               0 |                                                               0.4 |
|                                                               0.50 |                                                               0 |                                                               0 |                                                               0.5 |
|                                                              -0.49 |                                                               0 |                                                               0 |                                                              -0.4 |
|                                                              -0.50 |                                                               0 |                                                               0 |                                                              -0.5 |
|  99999999999999999999999999999999999999999999999999999999999999.99 |  99999999999999999999999999999999999999999999999999999999999990 |  99999999999999999999999999999999999999999999999999999999999999 |  99999999999999999999999999999999999999999999999999999999999999.9 |
| -99999999999999999999999999999999999999999999999999999999999999.99 | -99999999999999999999999999999999999999999999999999999999999990 | -99999999999999999999999999999999999999999999999999999999999999 | -99999999999999999999999999999999999999999999999999999999999999.9 |
|                                                               NULL |                                                            NULL |                                                            NULL |                                                              NULL |
+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------------------------------------------------+-------------------------------------------------------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, 2)), sum(truncate(a, -61)), sum(truncate(a, -62)) from test.d64 group by id order by id
+--------------------------------------------------------------------+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------+
| sum(a)                                                             | sum(truncate(a, 2))                                                | sum(truncate(a, -61))                                           | sum(truncate(a, -62)) |
+--------------------------------------------------------------------+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------+
|                                                               0.00 |                                                               0.00 |                                                               0 |                     0 |
|                                                               0.25 |                                                               0.25 |                                                               0 |                     0 |
|                                                              -0.25 |                                                              -0.25 |                                                               0 |                     0 |
|                                                              25.00 |                                                              25.00 |                                                               0 |                     0 |
|                                                             -25.00 |                                                             -25.00 |                                                               0 |                     0 |
|  49999999999999999999999999999999999999999999999999999999999999.99 |  49999999999999999999999999999999999999999999999999999999999999.99 |  40000000000000000000000000000000000000000000000000000000000000 |                     0 |
|  50000000000000000000000000000000000000000000000000000000000000.00 |  50000000000000000000000000000000000000000000000000000000000000.00 |  50000000000000000000000000000000000000000000000000000000000000 |                     0 |
| -49999999999999999999999999999999999999999999999999999999999999.99 | -49999999999999999999999999999999999999999999999999999999999999.99 | -40000000000000000000000000000000000000000000000000000000000000 |                     0 |
| -50000000000000000000000000000000000000000000000000000000000000.00 | -50000000000000000000000000000000000000000000000000000000000000.00 | -50000000000000000000000000000000000000000000000000000000000000 |                     0 |
|                                                               0.49 |                                                               0.49 |                                                               0 |                     0 |
|                                                               0.50 |                                                               0.50 |                                                               0 |                     0 |
|                                                              -0.49 |                                                              -0.49 |                                                               0 |                     0 |
|                                                              -0.50 |                                                              -0.50 |                                                               0 |                     0 |
|  99999999999999999999999999999999999999999999999999999999999999.99 |  99999999999999999999999999999999999999999999999999999999999999.99 |  90000000000000000000000000000000000000000000000000000000000000 |                     0 |
| -99999999999999999999999999999999999999999999999999999999999999.99 | -99999999999999999999999999999999999999999999999999999999999999.99 | -90000000000000000000000000000000000000000000000000000000000000 |                     0 |
|                                                               NULL |                                                               NULL |                                                            NULL |                  NULL |
+--------------------------------------------------------------------+--------------------------------------------------------------------+-----------------------------------------------------------------+-----------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(a), sum(truncate(a, -63)), sum(truncate(a, -100)) from test.d64 group by id order by id
+--------------------------------------------------------------------+-----------------------+------------------------+
| sum(a)                                                             | sum(truncate(a, -63)) | sum(truncate(a, -100)) |
+--------------------------------------------------------------------+-----------------------+------------------------+
|                                                               0.00 |                     0 |                      0 |
|                                                               0.25 |                     0 |                      0 |
|                                                              -0.25 |                     0 |                      0 |
|                                                              25.00 |                     0 |                      0 |
|                                                             -25.00 |                     0 |                      0 |
|  49999999999999999999999999999999999999999999999999999999999999.99 |                     0 |                      0 |
|  50000000000000000000000000000000000000000000000000000000000000.00 |                     0 |                      0 |
| -49999999999999999999999999999999999999999999999999999999999999.99 |                     0 |                      0 |
| -50000000000000000000000000000000000000000000000000000000000000.00 |                     0 |                      0 |
|                                                               0.49 |                     0 |                      0 |
|                                                               0.50 |                     0 |                      0 |
|                                                              -0.49 |                     0 |                      0 |
|                                                              -0.50 |                     0 |                      0 |
|  99999999999999999999999999999999999999999999999999999999999999.99 |                     0 |                      0 |
| -99999999999999999999999999999999999999999999999999999999999999.99 |                     0 |                      0 |
|                                                               NULL |                  NULL |                   NULL |
+--------------------------------------------------------------------+-----------------------+------------------------+

# const input, variable frac
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(null, i)) from test.t
+------------------------+
| sum(truncate(null, i)) |
+------------------------+
|                   NULL |
+------------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(-123456789123456789, i)) from test.t
+---------------------------------------+
| sum(truncate(-123456789123456789, i)) |
+---------------------------------------+
|                  -6145404623034293517 |
+---------------------------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(123456789123456789.123456789123456789, i)) from test.t
+---------------------------------------------------------+
| sum(truncate(123456789123456789.123456789123456789, i)) |
+---------------------------------------------------------+
|                  6145404623034293520.923182418812071315 |
+---------------------------------------------------------+

# variable input & frac
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(a, i)) from test.d9 cross join test.t where a >= 0
+---------------------+
| sum(truncate(a, i)) |
+---------------------+
|        7378633.8083 |
+---------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(a, i)) from test.d9 cross join test.t where a < 0
+---------------------+
| sum(truncate(a, i)) |
+---------------------+
|       -7378633.8083 |
+---------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(a, i)) from test.d64 cross join test.t where a >= 0
+----------------------------------------------------------------------+
| sum(truncate(a, i))                                                  |
+----------------------------------------------------------------------+
| 18777777777777777777777777777777777777777777777777777777777778661.72 |
+----------------------------------------------------------------------+
mysql> set tidb_isolation_read_engines='tiflash'; set tidb_allow_mpp = 1; set tidb_enforce_mpp = 1; select sum(truncate(a, i)) from test.d64 cross join test.t where a < 0
+-----------------------------------------------------------------------+
| sum(truncate(a, i))                                                   |
+-----------------------------------------------------------------------+
| -18777777777777777777777777777777777777777777777777777777777778661.72 |
+-----------------------------------------------------------------------+
