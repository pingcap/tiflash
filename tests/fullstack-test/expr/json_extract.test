# Copyright 2023 PingCAP, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

mysql> drop table if exists test.t
mysql> create table test.t(a json, b json, c json, d json, e json)
mysql> alter table test.t set tiflash replica 1
mysql> insert into test.t values(null, '{\"a\" : \"b\", \"aa\" : \"bb\"}', '[1,2,[3,4]]', '[1,2,{\"a\":\"b\"}]', '\"hello world\"') #NO_UNESCAPE

mysql> drop table if exists test.t_json;
mysql> create table test.t_json(col_json json);
mysql> alter table test.t_json set tiflash replica 1;
mysql> insert into test.t_json values(null), ('[]'), ('{}'), ('{\"a\":{\"c\":{}, \"d\":{}}, \"b\":{\"e\":{}, \"f\":{}}}'); #NO_UNESCAPE

mysql> drop table if exists test.t_path;
mysql> create table test.t_path(col_path varchar(100));
mysql> alter table test.t_path set tiflash replica 1;
mysql> insert into test.t_path values(null), ('$'), ('\$[0]'), ('\$[1]'), ('\$.a'), ('\$.b'); #NO_UNESCAPE

func> wait_table test t
func> wait_table test t_json
func> wait_table test t_path

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select a->'\$.a' as col_a, b->'\$.a' as col_b, c->'\$[2]' as col_c, d->'\$[0].\"a\"' as col_d, e->'\$[*]' from test.t #NO_UNESCAPE
+-------+-------+--------+-------+-----------+
| col_a | col_b | col_c  | col_d | e->'$[*]' |
+-------+-------+--------+-------+-----------+
| NULL  | "b"   | [3, 4] | NULL  | NULL      |
+-------+-------+--------+-------+-----------+

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select b->'\$.*' as col_a, c->'\$[*]' as col_b, d->'\$**.a'  from test.t #NO_UNESCAPE
+-------------+----------------+------------+
| col_a       | col_b          | d->'$**.a' |
+-------------+----------------+------------+
| ["b", "bb"] | [1, 2, [3, 4]] | ["b"]      |
+-------------+----------------+------------+

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select json_extract(b, '\$.*') as col_a, json_extract(c, '\$[*]') as col_b, json_extract(d, '\$**.a') as col_c from test.t #NO_UNESCAPE
+-------------+----------------+-------+
| col_a       | col_b          | col_c |
+-------------+----------------+-------+
| ["b", "bb"] | [1, 2, [3, 4]] | ["b"] |
+-------------+----------------+-------+

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select json_extract(d, '\$[0]', '\$[1]', '\$[2].a') as col_a from test.t #NO_UNESCAPE
+-------------+
| col_a       |
+-------------+
| [1, 2, "b"] |
+-------------+

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select json_extract(NULL, '\$[0]', '\$[1]', '\$[2].a') as col_a from test.t #NO_UNESCAPE
+-------+
| col_a |
+-------+
| NULL  |
+-------+

mysql> set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select json_extract(d, '\$[0]', NULL, '\$[2].a') as col_a from test.t #NO_UNESCAPE
+-------+
| col_a |
+-------+
| NULL  |
+-------+

mysql> set tidb_allow_mpp=1;set tidb_enforce_mpp=1; set tidb_isolation_read_engines='tiflash'; select col_json, col_path, json_extract(col_json, col_path) as res from (select * from test.t_json join test.t_path) t order by col_json, col_path;
+----------------------------------------------------+----------+----------------------------------------------------+
| col_json                                           | col_path | res                                                |
+----------------------------------------------------+----------+----------------------------------------------------+
| NULL                                               | NULL     | NULL                                               |
| NULL                                               | $        | NULL                                               |
| NULL                                               | $.a      | NULL                                               |
| NULL                                               | $.b      | NULL                                               |
| NULL                                               | $[0]     | NULL                                               |
| NULL                                               | $[1]     | NULL                                               |
| {}                                                 | NULL     | NULL                                               |
| {}                                                 | $        | {}                                                 |
| {}                                                 | $.a      | NULL                                               |
| {}                                                 | $.b      | NULL                                               |
| {}                                                 | $[0]     | {}                                                 |
| {}                                                 | $[1]     | NULL                                               |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | NULL     | NULL                                               |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | $        | {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | $.a      | {"c": {}, "d": {}}                                 |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | $.b      | {"e": {}, "f": {}}                                 |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | $[0]     | {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} |
| {"a": {"c": {}, "d": {}}, "b": {"e": {}, "f": {}}} | $[1]     | NULL                                               |
| []                                                 | NULL     | NULL                                               |
| []                                                 | $        | []                                                 |
| []                                                 | $.a      | NULL                                               |
| []                                                 | $.b      | NULL                                               |
| []                                                 | $[0]     | NULL                                               |
| []                                                 | $[1]     | NULL                                               |
+----------------------------------------------------+----------+----------------------------------------------------+

mysql> drop table if exists test.t
mysql> drop table if exists test.t_json
mysql> drop table if exists test.t_path
