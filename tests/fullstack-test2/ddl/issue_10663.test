# Copyright 2026 PingCAP, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

mysql> DROP DATABASE IF EXISTS test_100;
mysql> CREATE DATABASE test_100;
mysql> CREATE TABLE test_100.t1 (a INT, b INT);
# prepare some rows inserted before column with default value added
mysql> INSERT INTO test_100.t1 VALUES (1, 2), (2, 3);
mysql> ALTER TABLE test_100.t1 set tiflash replica 1;
func> wait_table test_100 t1
# add new column with default value and insert some rows
mysql> ALTER TABLE test_100.t1 ADD COLUMN site_code VARCHAR(64) NOT NULL DEFAULT '100';
mysql> INSERT INTO test_100.t1 VALUES (12, 13, '100');
# change the default value so that it may share the same structure with another table
mysql> ALTER TABLE test_100.t1 MODIFY COLUMN site_code VARCHAR(64) NOT NULL DEFAULT '';
mysql> ALTER TABLE test_100.t1 ADD PRIMARY KEY (a, site_code);

mysql> DROP DATABASE IF EXISTS test_200;
mysql> CREATE DATABASE test_200;
mysql> CREATE TABLE test_200.t1 (a INT, b INT);
# prepare some rows inserted before column with default value added
mysql> INSERT INTO test_200.t1 VALUES (1, 2), (2, 3);
mysql> ALTER TABLE test_200.t1 set tiflash replica 1;
func> wait_table test_200 t1
# add new column with default value and insert some rows
mysql> ALTER TABLE test_200.t1 ADD COLUMN site_code VARCHAR(64) NOT NULL DEFAULT '200';
mysql> INSERT INTO test_200.t1 VALUES (12, 13, '200');
# change the default value so that it may share the same structure with test_100.t1
mysql> ALTER TABLE test_200.t1 MODIFY COLUMN site_code VARCHAR(64) NOT NULL DEFAULT '';
mysql> ALTER TABLE test_200.t1 ADD PRIMARY KEY (a, site_code);

mysql> set session tidb_isolation_read_engines='tiflash'; select * from test_100.t1 order by a;
+----+----+-----------+
| a  | b  | site_code |
+----+----+-----------+
| 1  | 2  | 100       |
| 2  | 3  | 100       |
| 12 | 13 | 100       |
+----+----+-----------+

mysql> set session tidb_isolation_read_engines='tiflash'; select * from test_200.t1 order by a;
+----+----+-----------+
| a  | b  | site_code |
+----+----+-----------+
| 1  | 2  | 200       |
| 2  | 3  | 200       |
| 12 | 13 | 200       |
+----+----+-----------+
