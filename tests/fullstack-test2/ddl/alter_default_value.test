# Copyright 2023 PingCAP, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

mysql> drop table if exists test.t
mysql> create table test.t(a int)
mysql> alter table test.t set tiflash replica 1
mysql> insert into test.t (a) values (1);
mysql> insert into test.t (a) values (1);

#############
# Alter year column
mysql> alter table test.t add column b year not null;

func> wait_table test t

mysql> set session tidb_isolation_read_engines='tiflash'; select /*+ read_from_storage(tiflash[t]) */ * from test.t;
+------+------+
| a    | b    |
+------+------+
|    1 | 0000 |
|    1 | 0000 |
+------+------+

mysql> alter table test.t add column c year not null;
mysql> set session tidb_isolation_read_engines='tiflash'; select /*+ read_from_storage(tiflash[t]) */ * from test.t;
+------+------+------+
| a    | b    | c    |
+------+------+------+
|    1 | 0000 | 0000 |
|    1 | 0000 | 0000 |
+------+------+------+

mysql> alter table test.t drop column b;
mysql> alter table test.t drop column c;

#############
# Alter varchar / enum column
mysql> alter table test.t add s varchar(999) default 'sss'
mysql> alter table test.t add e enum('unknown', 'male','female') default 'unknown'

mysql> set session tidb_isolation_read_engines='tiflash'; select * from test.t;
+---+-----+---------+
| a | s   | e       |
+---+-----+---------+
| 1 | sss | unknown |
| 1 | sss | unknown |
+---+-----+---------+
mysql> alter table test.t drop column s;
mysql> alter table test.t drop column e;

#############
# Alter bit column
mysql> alter table test.t add column b1 bit(1) not null;
mysql> alter table test.t add column b2 bit(1) not null default b'0';
mysql> alter table test.t add column b3 bit(32) default 0x010203;
mysql> alter table test.t add column b4 bit(32) default b'000000010000001000000011';
mysql> alter table test.t add column b5 bit(32) default b'000000010000001000000011';
mysql> alter table test.t add column b6 bit(32) default b'000000010000001000000011';
mysql> alter table test.t add column b7 bit(32) not null default b'000000010000001000000011';
# TiDB is dumb, see https://github.com/pingcap/tidb/issues/17641 and https://github.com/pingcap/tidb/issues/17642
# Cannot add the following lines, which are supposed to give us a little more coverage, until TiDB stops being dumb.
# mysql> alter table test.t modify column b5 bit(32);
# mysql> alter table test.t modify column b6 bit(64);
# mysql> alter table test.t modify column b7 bit(32);

# MySQL client will mess up the raw bit value output so use hex function.
mysql> set session tidb_isolation_read_engines='tiflash'; select hex(b1), hex(b2), hex(b3), hex(b4), hex(b5), hex(b6), hex(b7) from test.t;
+---------+---------+---------+---------+---------+---------+---------+
| hex(b1) | hex(b2) | hex(b3) | hex(b4) | hex(b5) | hex(b6) | hex(b7) |
+---------+---------+---------+---------+---------+---------+---------+
| 0       | 0       | 10203   | 10203   | 10203   | 10203   | 10203   |
| 0       | 0       | 10203   | 10203   | 10203   | 10203   | 10203   |
+---------+---------+---------+---------+---------+---------+---------+

mysql> alter table test.t drop column b1;
mysql> alter table test.t drop column b2;
mysql> alter table test.t drop column b3;
mysql> alter table test.t drop column b4;
mysql> alter table test.t drop column b5;
mysql> alter table test.t drop column b6;
mysql> alter table test.t drop column b7;

###########
# Alter enum with unsupported collate
mysql> alter table test.t add column e enum('Critical','Major','Minor','URGENT','High','Medium','Low','Unprioritized') COLLATE utf8mb4_bin DEFAULT 'Unprioritized';

mysql> set session tidb_isolation_read_engines='tiflash'; select /*+ read_from_storage(tiflash[t]) */ * from test.t;
+------+---------------+
| a    | e             |
+------+---------------+
|    1 | Unprioritized |
|    1 | Unprioritized |
+------+---------------+

mysql> alter table test.t drop column e;

#############
# Alter table... add column with default value
mysql> alter table test.t add column col1 int default 30; 
mysql> alter table test.t add column col2 year not null;
mysql> alter table test.t add column col3 decimal(6,2) not null;
mysql> alter table test.t add column col4 decimal(6,2) default "1.234";
mysql> alter table test.t add column col5 int default 123;
mysql> alter table test.t add column col6 varchar(255) default 'sss';
mysql> alter table test.t add column col7 timestamp default '2017-02-11';
mysql> alter table test.t add column col8 datetime default '2018-11-04 23:12:03';
mysql> alter table test.t add column col9 year default '2012';
mysql> alter table test.t add column col10 set('value1', 'value2', 'value3') default 'value3';
mysql> alter table test.t add column col11 enum('value1', 'value2', 'value3') default 'value1';
mysql> alter table test.t add column col12 datetime default '2018-11-04 23:12:03';
mysql> alter table test.t add column col13 time default  '2017-02-23 12:18:30';
mysql> alter table test.t add column col14 time default null;
mysql> alter table test.t add column col15 bit(32) default b'000000010000001000000011';
mysql> set session tidb_isolation_read_engines='tiflash'; select col1, col2, col3, col4, col5, col6, col7, col8, col9, col10, col11, col12, col13, col14, hex(col15) from test.t;
+------+------+------+------+------+------+---------------------+---------------------+------+--------+--------+---------------------+----------+-------+------------+
| col1 | col2 | col3 | col4 | col5 | col6 | col7                | col8                | col9 | col10  | col11  | col12               | col13    | col14 | hex(col15) |
+------+------+------+------+------+------+---------------------+---------------------+------+--------+--------+---------------------+----------+-------+------------+
|   30 | 0000 | 0.00 | 1.23 |  123 | sss  | 2017-02-11 00:00:00 | 2018-11-04 23:12:03 | 2012 | value3 | value1 | 2018-11-04 23:12:03 | 12:18:30 | NULL  | 10203      |
|   30 | 0000 | 0.00 | 1.23 |  123 | sss  | 2017-02-11 00:00:00 | 2018-11-04 23:12:03 | 2012 | value3 | value1 | 2018-11-04 23:12:03 | 12:18:30 | NULL  | 10203      |
+------+------+------+------+------+------+---------------------+---------------------+------+--------+--------+---------------------+----------+-------+------------+
mysql> drop table if exists test.t

#############
# issue 10680, TiFlash data inconsistent with TiKV after modifying a column from NOT NULL to NULL
mysql> DROP DATABASE IF EXISTS db_1483421321;
mysql> CREATE DATABASE db_1483421321;
mysql> CREATE TABLE db_1483421321.t0(c0 TINYINT, handle INT NOT NULL AUTO_INCREMENT, PRIMARY KEY(handle));
mysql> ALTER TABLE db_1483421321.t0 SET TIFLASH REPLICA 1;
func> wait_table db_1483421321 t0
# empty table
mysql> set session tidb_isolation_read_engines='tiflash'; SELECT * FROM db_1483421321.t0 order by handle;
mysql> set session tidb_isolation_read_engines='tikv'; SELECT * FROM db_1483421321.t0 order by handle;

mysql> ALTER TABLE db_1483421321.t0 ADD COLUMN c1 DECIMAL NULL;
mysql> ALTER TABLE db_1483421321.t0 ADD COLUMN c2 FLOAT NULL DEFAULT 0.0795439693286002;
mysql> ALTER TABLE db_1483421321.t0 ADD COLUMN c5 DECIMAL NOT NULL;
mysql> ALTER TABLE db_1483421321.t0 ADD COLUMN c4 DECIMAL DEFAULT 247262911;
mysql> ALTER TABLE db_1483421321.t0 MODIFY COLUMN c2 FLOAT NOT NULL;
mysql> ALTER TABLE db_1483421321.t0 MODIFY COLUMN c5 DECIMAL NULL;
mysql> ALTER TABLE db_1483421321.t0 MODIFY COLUMN c1 BIGINT DEFAULT -56083770 NOT NULL;

# first insert
mysql> INSERT IGNORE INTO db_1483421321.t0 (c1, c2, c5, c4) VALUES (-2051270087, 0.44141045099028775, 0.0, 15523);
# update and generate a new raftlog
mysql> UPDATE db_1483421321.t0 SET c5 = 870337888;
mysql> ALTER TABLE db_1483421321.t0 MODIFY COLUMN c1 BIGINT NULL;

# insert and generate the third raftlog
mysql> INSERT INTO db_1483421321.t0 (c2, c5, c4) VALUES (0.004406799693866592, 0.8752311290235516, 14652);
mysql> set session tidb_isolation_read_engines='tiflash'; SELECT * FROM db_1483421321.t0 order by handle;
+------+--------+-------------+--------------+-----------+-------+
| c0   | handle | c1          | c2           | c5        | c4    |
+------+--------+-------------+--------------+-----------+-------+
| NULL |      1 | -2051270087 |   0.44141045 | 870337888 | 15523 |
| NULL |      2 |        NULL | 0.0044067996 |         1 | 14652 |
+------+--------+-------------+--------------+-----------+-------+
mysql> set session tidb_isolation_read_engines='tikv'; SELECT * FROM db_1483421321.t0 order by handle;
+------+--------+-------------+--------------+-----------+-------+
| c0   | handle | c1          | c2           | c5        | c4    |
+------+--------+-------------+--------------+-----------+-------+
| NULL |      1 | -2051270087 |   0.44141045 | 870337888 | 15523 |
| NULL |      2 |        NULL | 0.0044067996 |         1 | 14652 |
+------+--------+-------------+--------------+-----------+-------+

# more insert
mysql> INSERT INTO db_1483421321.t0 (c2, c5, c4) VALUES (0.004406799693866592, 0.8752311290235516, 14652);
mysql> set session tidb_isolation_read_engines='tiflash'; SELECT * FROM db_1483421321.t0 order by handle;
+------+--------+-------------+--------------+-----------+-------+
| c0   | handle | c1          | c2           | c5        | c4    |
+------+--------+-------------+--------------+-----------+-------+
| NULL |      1 | -2051270087 |   0.44141045 | 870337888 | 15523 |
| NULL |      2 |        NULL | 0.0044067996 |         1 | 14652 |
| NULL |      3 |        NULL | 0.0044067996 |         1 | 14652 |
+------+--------+-------------+--------------+-----------+-------+
mysql> set session tidb_isolation_read_engines='tikv'; SELECT * FROM db_1483421321.t0 order by handle;
+------+--------+-------------+--------------+-----------+-------+
| c0   | handle | c1          | c2           | c5        | c4    |
+------+--------+-------------+--------------+-----------+-------+
| NULL |      1 | -2051270087 |   0.44141045 | 870337888 | 15523 |
| NULL |      2 |        NULL | 0.0044067996 |         1 | 14652 |
| NULL |      3 |        NULL | 0.0044067996 |         1 | 14652 |
+------+--------+-------------+--------------+-----------+-------+
